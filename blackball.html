<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>黒色ボール</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      margin-bottom: 60px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* ▼ 学習セクション ▼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

        .tips-grid {
  display: flex;          /* 横並びにする */
  flex-wrap: wrap;        /* 画面幅に合わせて折り返す */
  gap: 16px;              /* ボックス間の隙間 */
}

  </style>
</head>
<body>

  <header>
    <h1>黒色ボール</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ホーム</a>
    <a href="ball1.html">ボール検知学習について</a>
    <a href="silverball.html">銀色ボール</a>

  </nav>

  <main>
    <video controls>
      <source src="ball.mp4" type="video/mp4">
      お使いのブラウザは動画再生に対応していません。
    </video>
<div class="caption">
  ロボカップジュニアのレスキュー競技における黒色ボール検出の学習の一環として、ロボットが走行する様子を撮影した動画です。  
  ロボットは、黒色ボールを検知して自律的に救助行動を行う能力を学習しています。
</div>


    <h2>rai_sarch.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code>import time
import cv2
import numpy as np
import random
from etrobo_python import ETRobo
from etrobo_python.device import Motor, SonarSensor

# =========================
# 1. サーボモーター対応確認
# =========================
try:
    from etrobo_python import Servo
    HAS_SERVO = True  # サーボモーターが利用可能
except ImportError:
    HAS_SERVO = False  # サーボモーターはなし

device_type_arm = Servo if HAS_SERVO else Motor  # アームに使うデバイスを選択

# =========================
# 2. 各デバイスの接続ポート
# =========================
PORT_LEFT_MOTOR = 'A'    # 左モーター
PORT_RIGHT_MOTOR = 'B'   # 右モーター
PORT_ARM_LEFT = 'C'      # 左アーム
PORT_ARM_RIGHT = 'F'     # 右アーム
PORT_ULTRASONIC = 'E'    # 超音波センサー

# =========================
# 3. 動作パラメータ
# =========================
POWER = 100           # アーム動作のパワー
MOVE_POWER = 100      # 移動用モーターのパワー
FORWARD_POWER = 120   # 前進用パワー
TURN_POWER = 120      # 回転用パワー
FORWARD_TIME = 1.0    # 前進時間（秒）
TURN_TIME = 1.5       # 回転時間（秒）
ARM_MOVE_TIME = 0.6   # アーム下降時間（秒）
ARM_MOVE_TIME2 = 0.5  # アーム上昇時間（秒）
WALL_DISTANCE = 85    # 超音波センサーで壁と判断する距離（cm）

# =========================
# 4. カメラ設定
# =========================
from picamera2 import Picamera2
picam2 = Picamera2()
picam2.configure(picam2.create_preview_configuration(
    main={"format": "RGB888", "size": (320, 320)}
))
picam2.start()
time.sleep(1.0)  # カメラ準備時間

# =========================
# 5. 黒色検出関数
# =========================
def detect_black(frame):
    """画像内に黒色領域があるか判定"""
    hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
    lower_black = np.array([0, 0, 0])
    upper_black = np.array([180, 255, 50])
    mask = cv2.inRange(hsv, lower_black, upper_black)  # 黒色マスク

    contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    for cnt in contours:
        area = cv2.contourArea(cnt)
        if area > 1000:  # 十分大きい黒色ならTrue
            return True
    return False

# =========================
# 6. ボールすくい動作
# =========================
def scoop_ball(arm_left, arm_right, left_motor, right_motor):
    """ボールを拾って壁に運ぶ一連の動作"""
    print("[INFO] ボールをすくいます")

    # アームを下げる
    print("[INFO] アームを下げる")
    arm_left.set_power(-POWER)
    arm_right.set_power(POWER)
    time.sleep(ARM_MOVE_TIME)

    # 壁まで前進
    print("[INFO] ボールを壁まで運ぶ（10秒）")
    left_motor.set_power(70)
    right_motor.set_power(70)
    time.sleep(10.0)
    left_motor.set_power(0)
    right_motor.set_power(0)

    # 後退
    print("[INFO] 後退")
    left_motor.set_power(-60)
    right_motor.set_power(-60)
    time.sleep(4.0)
    left_motor.set_power(0)
    right_motor.set_power(0)

    # アームを上げる
    print("[INFO] アームを上げる")
    arm_left.set_power(POWER)
    arm_right.set_power(-POWER)
    time.sleep(ARM_MOVE_TIME2)

    # 再度壁まで前進
    print("[INFO] 壁まで運ぶ（4秒）")
    left_motor.set_power(70)
    right_motor.set_power(70)
    time.sleep(4.0)
    left_motor.set_power(0)
    right_motor.set_power(0)

    # アームを下げる
    print("[INFO] アームを下げる")
    arm_left.set_power(-POWER)
    arm_right.set_power(POWER)
    time.sleep(ARM_MOVE_TIME)

    print("[INFO] すくい動作完了")
    arm_left.set_power(0)
    arm_right.set_power(0)

# =========================
# 7. ランダムウォーク＋超音波回避探索
# =========================
def rescue_sequence(left_motor, right_motor, arm_left, arm_right, ultrasonic, **kwargs):
    """黒い物体探索＋発見時にボールすくい"""
    print("[INFO] ランダムウォーク探索開始（超音波で壁回避）")
    found_black = False
    stop_counter = 0

    while True:
        frame = picam2.capture_array()
        frame = cv2.resize(frame, (320, 320))
        detected = detect_black(frame)  # 黒色検出
        distance = ultrasonic.get_distance()  # 超音波測距
        print(f"[INFO] 距離: {distance:.1f} cm")

        if detected:
            stop_counter += 1
            print(f"[INFO] 黒色検出 ({stop_counter}/3)")
            if stop_counter >= 3:
                found_black = True
                break
        else:
            stop_counter = 0
            if 0 < distance < WALL_DISTANCE:
                # 壁回避
                print("[INFO] 壁検出！後退して回転")
                left_motor.set_power(-MOVE_POWER)
                right_motor.set_power(-MOVE_POWER)
                time.sleep(0.8)
                turn_dir = random.choice(["left", "right"])
                if turn_dir == "left":
                    left_motor.set_power(-TURN_POWER)
                    right_motor.set_power(TURN_POWER)
                else:
                    left_motor.set_power(TURN_POWER)
                    right_motor.set_power(-TURN_POWER)
                time.sleep(0.8)
            else:
                # ランダムウォーク動作
                action = random.choice(["forward", "left", "right", "backward"])
                if action == "forward":
                    print("[RANDOM WALK] 前進")
                    left_motor.set_power(FORWARD_POWER)
                    right_motor.set_power(FORWARD_POWER)
                    time.sleep(FORWARD_TIME)
                elif action == "backward":
                    print("[RANDOM WALK] 後退")
                    left_motor.set_power(-FORWARD_POWER)
                    right_motor.set_power(-FORWARD_POWER)
                    time.sleep(FORWARD_TIME)
                elif action == "left":
                    print("[RANDOM WALK] 左旋回")
                    left_motor.set_power(-TURN_POWER)
                    right_motor.set_power(TURN_POWER)
                    time.sleep(TURN_TIME)
                elif action == "right":
                    print("[RANDOM WALK] 右旋回")
                    left_motor.set_power(TURN_POWER)
                    right_motor.set_power(-TURN_POWER)
                    time.sleep(TURN_TIME)

            # モーター停止
            left_motor.set_power(0)
            right_motor.set_power(0)
            time.sleep(0.3)

    if found_black:
        print("[INFO] 黒色確認！すくい動作開始")
        scoop_ball(arm_left, arm_right, left_motor, right_motor)

    cv2.destroyAllWindows()
    print("[INFO] 探索・救出動作完了")

# =========================
# 8. ETRobo デバイス初期化＆実行
# =========================
device_type_arm = Servo if HAS_SERVO else Motor
print(f"HAS_SERVO = {HAS_SERVO}")
print(f"使用するアームデバイス = {device_type_arm}")

(
    ETRobo(backend='raspike_art')  # Bluetoothの場合は 'bt'
    .add_device('left_motor', Motor, port=PORT_LEFT_MOTOR)
    .add_device('right_motor', Motor, port=PORT_RIGHT_MOTOR)
    .add_device('arm_left', device_type_arm, port=PORT_ARM_LEFT)
    .add_device('arm_right', device_type_arm, port=PORT_ARM_RIGHT)
    .add_device('ultrasonic', SonarSensor, port=PORT_ULTRASONIC)
    .add_handler(rescue_sequence)  # 探索・救出処理を登録
    .dispatch(interval=0.5, port='/dev/ttyACM0')  # 実行開始
)

</code></pre>
      </div>

      <div class="desc-box">
    <h3>プログラムの説明</h3>
    <p>
        このプログラムは、ETRobo ロボットを使って「黒い物体を探してボールをすくい上げ、壁まで運ぶ」という一連の救出動作を実現するものです。<br>
        カメラで黒色を検出し、超音波で壁を避けながらランダムに動き、黒を見つけたらアームでボールをすくいます。
    </p>

    <h4>① サーボモーターの確認部分</h4>
    <p>
        ここではサーボモーターが使える環境かどうかをチェックしています。<br>
        Servo が使える場合はアームとしてサーボを使用し、使えない場合は通常の Motor をアームとして利用します。
    </p>
    <p><b>ポイント：</b> Servo があるかどうかで、自動的にアームのデバイスを切り替えています。</p>

    <h4>② 使用するデバイスのポート番号を定義する部分</h4>
    <p>
        ロボットに接続されているデバイス（モーター・アーム・超音波センサー）をどのポートに接続しているかをここで設定しています。
    </p>
    <ul>
        <li>左右の走行モーター</li>
        <li>左右のアーム</li>
        <li>超音波センサー</li>
    </ul>

    <h4>③ ロボットの動作パラメータ設定</h4>
    <p>
        移動時のパワー、回転パワー、前進にかける時間、アームを上下させる時間、壁と判断する距離などをまとめて設定しています。<br>
        これらの値はロボットの動きを調整するために非常に重要です。
    </p>

    <h4>④ カメラの設定</h4>
    <p>
        Picamera2 を使ってカメラを起動し、画像サイズを 320×320 に設定しています。<br>
        カメラが安定して動作するまで 1 秒待機しています。
    </p>

    <h4>⑤ 黒色を検出する関数（detect_black）</h4>
    <p>
        この関数では、カメラで取得した画像から黒い物体が存在するかを判定します。
    </p>
    <ul>
        <li>BGR → HSV へ変換</li>
        <li>黒色の範囲だけをマスクして抽出</li>
        <li>輪郭を検出し、その面積が一定以上なら「黒あり」と判断</li>
    </ul>
    <p>黒いボールや黒いターゲットを検出するための機能です。</p>

    <h4>⑥ ボールをすくう動作（scoop_ball）</h4>
    <p>黒い物体を見つけた後、アームを使ってボールをすくい、壁まで運ぶ一連の動きをまとめた関数です。</p>
    <ol>
        <li>アームを下げる</li>
        <li>10秒前進して壁まで運ぶ</li>
        <li>後退する</li>
        <li>アームを上げる</li>
        <li>壁まで4秒前進</li>
        <li>アームをもう一度下げる</li>
    </ol>
    <p>この動きで「すくう → 運ぶ」が実現されています。</p>

    <h4>⑦ ランダムウォーク＋超音波回避による探索（rescue_sequence）</h4>
    <p>
        ロボットが黒い物体（ボール）を探すためのメイン処理です。
    </p>

    <h5>● カメラで黒色チェック</h5>
    <ul>
        <li>detect_black() で黒を検出</li>
        <li>3回連続で黒を検出したら確定（ノイズ対策）</li>
    </ul>

    <h5>● 超音波で壁チェック</h5>
    <ul>
        <li>壁の距離が近い → 後退 → ランダムで左 or 右へ回転</li>
    </ul>

    <h5>● ランダムウォーク</h5>
    <ul>
        <li>前進</li>
        <li>後退</li>
        <li>左旋回</li>
        <li>右旋回</li>
    </ul>

    <h5>● 黒を発見したら</h5>
    <p>scoop_ball() を実行してボールをすくいます。</p>

    <h4>⑧ ETRobo 初期化と実行開始</h4>
    <p>
        最後に、ETRobo にモーターやアーム、超音波センサーを登録して処理を開始します。
    </p>
    <ul>
        <li>rescue_sequence が 0.5 秒ごとに呼ばれる</li>
        <li>カメラと超音波による探索 → ボールすくいの流れが自動で動作</li>
    </ul>

    <p>これにより、ロボットは自律的に「探索 → 検出 → 救出」動作を行えるようになります。</p>
</div>

<div class="tips-section">
  <h2>よくある問題と改善のヒント</h2>
  <div class="tips-grid">

    <article class="desc-box">
      <h3>🖤 黒色ボールが正しく検出されない</h3>
      <p>・光の反射でボールが見えにくい<br>・背景の色と近すぎて誤認識<br>・AIモデルの学習データが不足</p>
      <p style="color:#16a34a; font-weight:600;">🌱 照明や背景、データ量を調整しよう！</p>
    </article>

    <article class="desc-box">
      <h3>📸 カメラ映像でボール位置がずれる</h3>
      <p>・カメラの取り付け角度や高さが不安定<br>・画像処理の解像度が低い<br>・OpenCVでの座標計算を確認</p>
      <p style="color:#2b7bd3; font-weight:600;">⚙️ カメラ位置と座標計算を見直そう！</p>
    </article>

    <article class="desc-box">
      <h3>🤖 ロボットがボールを拾えない／避ける</h3>
      <p>・検出位置とアームの動作範囲が合っていない<br>・モーター制御のタイミングがずれている<br>・検出座標をモーター制御に正しく反映</p>
      <p style="color:#16a34a; font-weight:600;">🎨 検出座標とアーム動作を合わせよう！</p>
    </article>

    <article class="desc-box">
      <h3>⚡ 検出が不安定で連続で認識できない</h3>
      <p>・AIモデルの学習枚数が少ない<br>・照明条件が変わると誤判定<br>・推論時の閾値やスムージングを調整</p>
      <p style="color:#2b7bd3; font-weight:600;">🧭 学習データと閾値を最適化！</p>
    </article>

    <article class="desc-box">
      <h3>⏱️ 検出後の動作タイミングがずれる</h3>
      <p>・AI認識からモーター制御までの処理時間が一定でない<br>・ボールまでの距離に応じて動作を調整</p>
      <p style="color:#16a34a; font-weight:600;">⏳ 認識→動作までの時間を微調整！</p>
    </article>

  </div>
</div>



    <!-- ▼ 学習のやり方セクション ▼ -->
    <div class="learn-section">
      <h2>📘 学習のやり方</h2>
      <p>黒色ボールの学習では、次の手順で理解を深めましょう。</p>
<ol class="learn-list">
    <li><b>1. 動作の確認：</b> まずは動画や実機で、ロボットが黒色ボールをどのように認識するか観察します。</li>
    <li><b>2. コードの理解：</b> カメラ取得・画像処理・モーター制御など、各関数の役割を順に読み解きます。</li>
    <li><b>3. 実験と調整：</b> ボールの色や光の反射条件を変えて、AI検出やロボットの反応を確認します。</li>
    <li><b>4. 応用：</b> 検出精度の向上や、救出動作の改善など、ロボット制御の応用を試してみます。</li>
  </ol>
  <p>実際にロボットを動かしながら学ぶことで、<strong>AIによる物体認識</strong>と<strong>センサー制御</strong>の関係をより深く理解できます。</p>
</div>

  </main>

</body>
</html>
