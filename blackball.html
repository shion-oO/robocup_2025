<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»’è‰²ãƒœãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      margin-bottom: 60px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* â–¼ å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

  </style>
</head>
<body>

  <header>
    <h1>é»’è‰²ãƒœãƒ¼ãƒ«</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="ball1.html">ãƒœãƒ¼ãƒ«æ¤œçŸ¥å­¦ç¿’ã«ã¤ã„ã¦</a>
    <a href="silverball.html">éŠ€è‰²ãƒœãƒ¼ãƒ«</a>

  </nav>

  <main>
    <video controls>
      <source src="ball.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
      ãƒ­ãƒœãƒƒãƒˆãŒé»’ã„ãƒ©ã‚¤ãƒ³ã«æ²¿ã£ã¦æ­£ç¢ºã«èµ°è¡Œã™ã‚‹æ§˜å­ã‚’æ’®å½±ã—ãŸå‹•ç”»ã§ã™ã€‚
    </div>

    <h2>rai_sarch.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code>import time
import cv2
import numpy as np
import random
from etrobo_python import ETRobo
from etrobo_python.device import Motor, SonarSensor

# =========================
# 1. ã‚µãƒ¼ãƒœãƒ¢ãƒ¼ã‚¿ãƒ¼å¯¾å¿œç¢ºèª
# =========================
try:
    from etrobo_python import Servo
    HAS_SERVO = True  # ã‚µãƒ¼ãƒœãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒåˆ©ç”¨å¯èƒ½
except ImportError:
    HAS_SERVO = False  # ã‚µãƒ¼ãƒœãƒ¢ãƒ¼ã‚¿ãƒ¼ã¯ãªã—

device_type_arm = Servo if HAS_SERVO else Motor  # ã‚¢ãƒ¼ãƒ ã«ä½¿ã†ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ

# =========================
# 2. å„ãƒ‡ãƒã‚¤ã‚¹ã®æ¥ç¶šãƒãƒ¼ãƒˆ
# =========================
PORT_LEFT_MOTOR = 'A'    # å·¦ãƒ¢ãƒ¼ã‚¿ãƒ¼
PORT_RIGHT_MOTOR = 'B'   # å³ãƒ¢ãƒ¼ã‚¿ãƒ¼
PORT_ARM_LEFT = 'C'      # å·¦ã‚¢ãƒ¼ãƒ 
PORT_ARM_RIGHT = 'F'     # å³ã‚¢ãƒ¼ãƒ 
PORT_ULTRASONIC = 'E'    # è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼

# =========================
# 3. å‹•ä½œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
# =========================
POWER = 100           # ã‚¢ãƒ¼ãƒ å‹•ä½œã®ãƒ‘ãƒ¯ãƒ¼
MOVE_POWER = 100      # ç§»å‹•ç”¨ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®ãƒ‘ãƒ¯ãƒ¼
FORWARD_POWER = 120   # å‰é€²ç”¨ãƒ‘ãƒ¯ãƒ¼
TURN_POWER = 120      # å›è»¢ç”¨ãƒ‘ãƒ¯ãƒ¼
FORWARD_TIME = 1.0    # å‰é€²æ™‚é–“ï¼ˆç§’ï¼‰
TURN_TIME = 1.5       # å›è»¢æ™‚é–“ï¼ˆç§’ï¼‰
ARM_MOVE_TIME = 0.6   # ã‚¢ãƒ¼ãƒ ä¸‹é™æ™‚é–“ï¼ˆç§’ï¼‰
ARM_MOVE_TIME2 = 0.5  # ã‚¢ãƒ¼ãƒ ä¸Šæ˜‡æ™‚é–“ï¼ˆç§’ï¼‰
WALL_DISTANCE = 85    # è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼ã§å£ã¨åˆ¤æ–­ã™ã‚‹è·é›¢ï¼ˆcmï¼‰

# =========================
# 4. ã‚«ãƒ¡ãƒ©è¨­å®š
# =========================
from picamera2 import Picamera2
picam2 = Picamera2()
picam2.configure(picam2.create_preview_configuration(
    main={"format": "RGB888", "size": (320, 320)}
))
picam2.start()
time.sleep(1.0)  # ã‚«ãƒ¡ãƒ©æº–å‚™æ™‚é–“

# =========================
# 5. é»’è‰²æ¤œå‡ºé–¢æ•°
# =========================
def detect_black(frame):
    """ç”»åƒå†…ã«é»’è‰²é ˜åŸŸãŒã‚ã‚‹ã‹åˆ¤å®š"""
    hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
    lower_black = np.array([0, 0, 0])
    upper_black = np.array([180, 255, 50])
    mask = cv2.inRange(hsv, lower_black, upper_black)  # é»’è‰²ãƒã‚¹ã‚¯

    contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    for cnt in contours:
        area = cv2.contourArea(cnt)
        if area > 1000:  # ååˆ†å¤§ãã„é»’è‰²ãªã‚‰True
            return True
    return False

# =========================
# 6. ãƒœãƒ¼ãƒ«ã™ãã„å‹•ä½œ
# =========================
def scoop_ball(arm_left, arm_right, left_motor, right_motor):
    """ãƒœãƒ¼ãƒ«ã‚’æ‹¾ã£ã¦å£ã«é‹ã¶ä¸€é€£ã®å‹•ä½œ"""
    print("[INFO] ãƒœãƒ¼ãƒ«ã‚’ã™ãã„ã¾ã™")

    # ã‚¢ãƒ¼ãƒ ã‚’ä¸‹ã’ã‚‹
    print("[INFO] ã‚¢ãƒ¼ãƒ ã‚’ä¸‹ã’ã‚‹")
    arm_left.set_power(-POWER)
    arm_right.set_power(POWER)
    time.sleep(ARM_MOVE_TIME)

    # å£ã¾ã§å‰é€²
    print("[INFO] ãƒœãƒ¼ãƒ«ã‚’å£ã¾ã§é‹ã¶ï¼ˆ10ç§’ï¼‰")
    left_motor.set_power(70)
    right_motor.set_power(70)
    time.sleep(10.0)
    left_motor.set_power(0)
    right_motor.set_power(0)

    # å¾Œé€€
    print("[INFO] å¾Œé€€")
    left_motor.set_power(-60)
    right_motor.set_power(-60)
    time.sleep(4.0)
    left_motor.set_power(0)
    right_motor.set_power(0)

    # ã‚¢ãƒ¼ãƒ ã‚’ä¸Šã’ã‚‹
    print("[INFO] ã‚¢ãƒ¼ãƒ ã‚’ä¸Šã’ã‚‹")
    arm_left.set_power(POWER)
    arm_right.set_power(-POWER)
    time.sleep(ARM_MOVE_TIME2)

    # å†åº¦å£ã¾ã§å‰é€²
    print("[INFO] å£ã¾ã§é‹ã¶ï¼ˆ4ç§’ï¼‰")
    left_motor.set_power(70)
    right_motor.set_power(70)
    time.sleep(4.0)
    left_motor.set_power(0)
    right_motor.set_power(0)

    # ã‚¢ãƒ¼ãƒ ã‚’ä¸‹ã’ã‚‹
    print("[INFO] ã‚¢ãƒ¼ãƒ ã‚’ä¸‹ã’ã‚‹")
    arm_left.set_power(-POWER)
    arm_right.set_power(POWER)
    time.sleep(ARM_MOVE_TIME)

    print("[INFO] ã™ãã„å‹•ä½œå®Œäº†")
    arm_left.set_power(0)
    arm_right.set_power(0)

# =========================
# 7. ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯ï¼‹è¶…éŸ³æ³¢å›é¿æ¢ç´¢
# =========================
def rescue_sequence(left_motor, right_motor, arm_left, arm_right, ultrasonic, **kwargs):
    """é»’ã„ç‰©ä½“æ¢ç´¢ï¼‹ç™ºè¦‹æ™‚ã«ãƒœãƒ¼ãƒ«ã™ãã„"""
    print("[INFO] ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯æ¢ç´¢é–‹å§‹ï¼ˆè¶…éŸ³æ³¢ã§å£å›é¿ï¼‰")
    found_black = False
    stop_counter = 0

    while True:
        frame = picam2.capture_array()
        frame = cv2.resize(frame, (320, 320))
        detected = detect_black(frame)  # é»’è‰²æ¤œå‡º
        distance = ultrasonic.get_distance()  # è¶…éŸ³æ³¢æ¸¬è·
        print(f"[INFO] è·é›¢: {distance:.1f} cm")

        if detected:
            stop_counter += 1
            print(f"[INFO] é»’è‰²æ¤œå‡º ({stop_counter}/3)")
            if stop_counter >= 3:
                found_black = True
                break
        else:
            stop_counter = 0
            if 0 < distance < WALL_DISTANCE:
                # å£å›é¿
                print("[INFO] å£æ¤œå‡ºï¼å¾Œé€€ã—ã¦å›è»¢")
                left_motor.set_power(-MOVE_POWER)
                right_motor.set_power(-MOVE_POWER)
                time.sleep(0.8)
                turn_dir = random.choice(["left", "right"])
                if turn_dir == "left":
                    left_motor.set_power(-TURN_POWER)
                    right_motor.set_power(TURN_POWER)
                else:
                    left_motor.set_power(TURN_POWER)
                    right_motor.set_power(-TURN_POWER)
                time.sleep(0.8)
            else:
                # ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯å‹•ä½œ
                action = random.choice(["forward", "left", "right", "backward"])
                if action == "forward":
                    print("[RANDOM WALK] å‰é€²")
                    left_motor.set_power(FORWARD_POWER)
                    right_motor.set_power(FORWARD_POWER)
                    time.sleep(FORWARD_TIME)
                elif action == "backward":
                    print("[RANDOM WALK] å¾Œé€€")
                    left_motor.set_power(-FORWARD_POWER)
                    right_motor.set_power(-FORWARD_POWER)
                    time.sleep(FORWARD_TIME)
                elif action == "left":
                    print("[RANDOM WALK] å·¦æ—‹å›")
                    left_motor.set_power(-TURN_POWER)
                    right_motor.set_power(TURN_POWER)
                    time.sleep(TURN_TIME)
                elif action == "right":
                    print("[RANDOM WALK] å³æ—‹å›")
                    left_motor.set_power(TURN_POWER)
                    right_motor.set_power(-TURN_POWER)
                    time.sleep(TURN_TIME)

            # ãƒ¢ãƒ¼ã‚¿ãƒ¼åœæ­¢
            left_motor.set_power(0)
            right_motor.set_power(0)
            time.sleep(0.3)

    if found_black:
        print("[INFO] é»’è‰²ç¢ºèªï¼ã™ãã„å‹•ä½œé–‹å§‹")
        scoop_ball(arm_left, arm_right, left_motor, right_motor)

    cv2.destroyAllWindows()
    print("[INFO] æ¢ç´¢ãƒ»æ•‘å‡ºå‹•ä½œå®Œäº†")

# =========================
# 8. ETRobo ãƒ‡ãƒã‚¤ã‚¹åˆæœŸåŒ–ï¼†å®Ÿè¡Œ
# =========================
device_type_arm = Servo if HAS_SERVO else Motor
print(f"HAS_SERVO = {HAS_SERVO}")
print(f"ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ¼ãƒ ãƒ‡ãƒã‚¤ã‚¹ = {device_type_arm}")

(
    ETRobo(backend='raspike_art')  # Bluetoothã®å ´åˆã¯ 'bt'
    .add_device('left_motor', Motor, port=PORT_LEFT_MOTOR)
    .add_device('right_motor', Motor, port=PORT_RIGHT_MOTOR)
    .add_device('arm_left', device_type_arm, port=PORT_ARM_LEFT)
    .add_device('arm_right', device_type_arm, port=PORT_ARM_RIGHT)
    .add_device('ultrasonic', SonarSensor, port=PORT_ULTRASONIC)
    .add_handler(rescue_sequence)  # æ¢ç´¢ãƒ»æ•‘å‡ºå‡¦ç†ã‚’ç™»éŒ²
    .dispatch(interval=0.5, port='/dev/ttyACM0')  # å®Ÿè¡Œé–‹å§‹
)

</code></pre>
      </div>

      <div class="desc-box">
        <h3>(ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜)</h3>
        <p>ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ã‚«ãƒ¡ãƒ©ã§é»’ç·šã‚’èªè­˜ã—ãªãŒã‚‰èµ°è¡Œã™ã‚‹ãƒ­ãƒœãƒƒãƒˆã®åˆ¶å¾¡ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <p><b>1ï¸âƒ£ ã‚«ãƒ¡ãƒ©è¨­å®šï¼š</b> 2å°ã®ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã€æ˜ åƒã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
        <p><b>2ï¸âƒ£ ç”»åƒå‡¦ç†ï¼š</b> OpenCVã§é»’ç·šã‚’æ¤œå‡ºã—ã€é‡å¿ƒä½ç½®ã‹ã‚‰é€²è¡Œæ–¹å‘ï¼ˆå·¦ãƒ»å³ãƒ»ä¸­å¤®ï¼‰ã‚’åˆ¤å®šã—ã¾ã™ã€‚</p>
        <p><b>3ï¸âƒ£ ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡ï¼š</b> é€²è¡Œæ–¹å‘ã«å¿œã˜ã¦å·¦å³ã®ãƒ¢ãƒ¼ã‚¿ãƒ¼å‡ºåŠ›ã‚’èª¿æ•´ã—ã€ãƒ©ã‚¤ãƒ³ä¸Šã‚’èµ°è¡Œã—ã¾ã™ã€‚</p>
        <p><b>4ï¸âƒ£ å®Ÿè¡Œéƒ¨åˆ†ï¼š</b> ETRoboãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã„ã€0.05ç§’ã”ã¨ã«åˆ¶å¾¡é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</p>
        <p>ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ãƒœãƒƒãƒˆã¯é»’ç·šã‚’è¿½ã„ã‹ã‘ã‚‹ã‚ˆã†ã«è‡ªå‹•ã§é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
      </div>
    </div>




    <!-- â–¼ å­¦ç¿’ã®ã‚„ã‚Šæ–¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ -->
    <div class="learn-section">
      <h2>ğŸ“˜ å­¦ç¿’ã®ã‚„ã‚Šæ–¹</h2>
      <p>ã‚®ãƒ£ãƒƒãƒ—ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ã®å­¦ç¿’ã§ã¯ã€æ¬¡ã®æ‰‹é †ã§ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚</p>
      <ol class="learn-list">
        <li><b>1. å‹•ä½œã®ç¢ºèªï¼š</b> ã¾ãšã¯å‹•ç”»ã‚’è¦‹ã¦ã€ãƒ­ãƒœãƒƒãƒˆãŒã©ã®ã‚ˆã†ã«é»’ç·šã‚’ãŸã©ã‚‹ã‹è¦³å¯Ÿã—ã¾ã™ã€‚</li>
        <li><b>2. ã‚³ãƒ¼ãƒ‰ã®ç†è§£ï¼š</b> å„é–¢æ•°ã®å½¹å‰²ï¼ˆã‚«ãƒ¡ãƒ©å–å¾—ãƒ»ç”»åƒå‡¦ç†ãƒ»ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡ï¼‰ã‚’é †ã«èª­ã¿è§£ãã¾ã™ã€‚</li>
        <li><b>3. å®Ÿé¨“ã¨èª¿æ•´ï¼š</b> é»’ç·šã®å¤ªã•ã‚„ã‚«ãƒ¡ãƒ©ã®ä½ç½®ã‚’å¤‰ãˆã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åå¿œã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</li>
        <li><b>4. å¿œç”¨ï¼š</b> é€Ÿåº¦ã‚„ã‚«ãƒ¼ãƒ–å‡¦ç†ã®èª¿æ•´ã€ã¾ãŸã¯äº¤å·®ç‚¹å¯¾å¿œã®æ”¹è‰¯ãªã©ã‚’è¡Œã£ã¦ã¿ã¾ã™ã€‚</li>
      </ol>
      <p>å®Ÿéš›ã«ãƒ­ãƒœãƒƒãƒˆã‚’å‹•ã‹ã—ãªãŒã‚‰å­¦ã¶ã“ã¨ã§ã€ã€Œã‚»ãƒ³ã‚µãƒ¼ã€ã¨ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ åˆ¶å¾¡ã€ã®é–¢ä¿‚ã‚’æ·±ãç†è§£ã§ãã¾ã™ã€‚</p>
    </div>

  </main>

</body>
</html>
