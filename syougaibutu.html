<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éšœå®³ç‰©</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* â–¼ å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

  </style>
</head>
<body>

  <header>
    <h1>éšœå®³ç‰©</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="speedbanmp.html">ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒãƒ³ãƒ—</a>
    <a href="gareki.html">ç“¦ç¤«</a>
    <a href="seesaw.html">ã‚·ãƒ¼ã‚½ãƒ¼</a>
    <a href="keisyaro.html">å‚¾æ–œè·¯</a>
  </nav>

  <main>
    <video controls>
      <source src="syougaibutu.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
    ãƒ­ãƒœãƒƒãƒˆãŒéšœå®³ç‰©ã‚’é¿ã‘ã¦èµ°è¡Œã™ã‚‹æ§˜å­ã‚’æ’®å½±ã—ãŸå‹•ç”»ã§ã™ã€‚
    </div>

    <h2>choonpa_only_shougaibutu.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code>import cv2
import numpy as np
from picamera2 import Picamera2
from etrobo_python import ETRobo, Motor, SonarSensor
import time

# --- ã‚«ãƒ¡ãƒ©ã®åˆæœŸè¨­å®š ---
cam0 = Picamera2(0)
cam0.configure(cam0.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam0.start()
time.sleep(1)

cam1 = Picamera2(1)
cam1.configure(cam1.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam1.start()
time.sleep(1)

last_direction = "CENTER"
avoid_mode = False  # éšœå®³ç‰©å›é¿ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°

# --- ãƒ©ã‚¤ãƒ³ã®ä½ç½®ã‹ã‚‰é€²è¡Œæ–¹å‘ã‚’åˆ¤å®šã™ã‚‹é–¢æ•° ---
def get_direction(frame, last_direction):
    hsv = cv2.cvtColor(frame, cv2.COLOR_RGB2HSV)
    lower_black = (0, 0, 0)
    upper_black = (180, 255, 80)
    mask = cv2.inRange(hsv, lower_black, upper_black)
    mask = cv2.GaussianBlur(mask, (5, 5), 0)

    height, width = mask.shape
    roi_height = 40
    roi_bottom = mask[height - roi_height:height, :]  # ä¸‹éƒ¨ã®ROIï¼ˆãƒ©ã‚¤ãƒ³æ¤œå‡ºç”¨é ˜åŸŸï¼‰
    roi_debug = cv2.cvtColor(mask.copy(), cv2.COLOR_GRAY2BGR)

    contours, _ = cv2.findContours(roi_bottom, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    cx_list = []
    for c in contours:
        if cv2.contourArea(c) > 400:  # å°ã•ã„ãƒã‚¤ã‚ºã‚’é™¤å»
            M = cv2.moments(c)
            if M["m00"] != 0:
                cx = int(M["m10"] / M["m00"])
                cy = int(M["m01"] / M["m00"])
                cx_list.append(cx)
                cv2.circle(roi_debug, (cx, cy + height - roi_height), 5, (0, 255, 0), -1)

    direction = last_direction
    tolerance = 20  # è¨±å®¹ç¯„å›²
    if cx_list:
        avg_cx = sum(cx_list) // len(cx_list)
        if avg_cx < width // 2 - tolerance:
            direction = "LEFT"   # å·¦ã¸
        elif avg_cx > width // 2 + tolerance:
            direction = "RIGHT"  # å³ã¸
        else:
            direction = "CENTER" # ã¾ã£ã™ã
    else:
        direction = last_direction  # ãƒ©ã‚¤ãƒ³ãŒè¦‹ãˆãªã„ã¨ãã¯å‰å›ã®æ–¹å‘ã‚’ç¶­æŒ

    return direction, roi_debug

# --- ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ã¨éšœå®³ç‰©å›é¿ã‚’åŒæ™‚ã«è¡Œã†ãƒ¡ã‚¤ãƒ³é–¢æ•° ---
def line_trace_and_avoid(right_motor: Motor, left_motor: Motor, sonar: SonarSensor):
    global last_direction, avoid_mode

    try:
        distance = sonar.get_distance()
        print(f"Sonar distance: {distance} mm")

        if avoid_mode:
            # éšœå®³ç‰©ã‚’é¿ã‘ãŸã‚ã¨ã®èµ°è¡ŒçµŒè·¯ï¼ˆé¿ã‘çµ‚ã‚ã‚Šå‹•ä½œï¼‰
            left_motor.set_power(60)
            right_motor.set_power(30)
            time.sleep(1.3)

            left_motor.set_power(30)
            right_motor.set_power(60)
            time.sleep(1.1)

            avoid_mode = False
            return

        if distance < 270:
            print("[AVOID] éšœå®³ç‰©ã‚’æ¤œå‡ºï¼ å›é¿å‹•ä½œã‚’é–‹å§‹ã—ã¾ã™...")
            avoid_mode = True
            return

        # ã‚«ãƒ¡ãƒ©ã‹ã‚‰æ˜ åƒã‚’å–å¾—
        frame0 = cam0.capture_array()
        frame1 = cam1.capture_array()

        direction, debug_mask0 = get_direction(frame0, last_direction)
        _, debug_mask1 = get_direction(frame1, last_direction)
        last_direction = direction

        print("Direction:", direction)

        # åŸºæœ¬é€Ÿåº¦ã‚’è¨­å®šï¼ˆæ–¹å‘ã«ã‚ˆã‚Šèª¿æ•´ï¼‰
        base = 35 if direction == "CENTER" else 30
        diff = 25

        if direction == "LEFT":
            right_motor.set_power(base + diff)
            left_motor.set_power(base - diff)
        elif direction == "RIGHT":
            right_motor.set_power(base - diff)
            left_motor.set_power(base + diff)
        else:
            right_motor.set_power(base)
            left_motor.set_power(base)

        # ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        cv2.imshow("Cam0 Mask", debug_mask0)
        cv2.imshow("Cam1 Mask", debug_mask1)
        cv2.waitKey(1)

    except Exception as e:
        print("[ERROR]:", e)

# --- å®Ÿè¡Œéƒ¨åˆ† ---
(ETRobo(backend='raspyke')
 .add_device('right_motor', device_type=Motor, port='B')
 .add_device('left_motor', device_type=Motor, port='C')
 .add_device('sonar', device_type=SonarSensor, port='S1')
 .add_handler(line_trace_and_avoid)
 .dispatch(interval=0.05))

</code></pre>
      </div>

<div class="desc-box">
  <h3>(ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜)</h3>

  <ol>
    <li>
      <strong>â‘  ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ä½¿ã†é“å…·ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰</strong><br>
      - <strong>cv2ï¼ˆOpenCVï¼‰</strong>ï¼šã‚«ãƒ¡ãƒ©æ˜ åƒã‚’å‡¦ç†ã—ã¦é»’ç·šã®ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹ã€‚<br>
      - <strong>numpyï¼ˆnpï¼‰</strong>ï¼šè¨ˆç®—ã‚„æ•°å€¤å‡¦ç†ã‚’ç°¡å˜ã«ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚<br>
      - <strong>Picamera2</strong>ï¼šRaspberry Piã®ã‚«ãƒ¡ãƒ©æ“ä½œç”¨ã€‚<br>
      - <strong>ETRobo / Motor / SonarSensor</strong>ï¼šãƒ­ãƒœãƒƒãƒˆæœ¬ä½“ãƒ»ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ»è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆ¶å¾¡ã€‚<br>
      - <strong>time</strong>ï¼šãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å¾…æ©Ÿï¼ˆsleepï¼‰ã™ã‚‹å‡¦ç†ã€‚
    </li>

    <li>
      <strong>â‘¡ ã‚«ãƒ¡ãƒ©ã®æº–å‚™</strong><br>
      - cam0 â†’ 1å°ç›®ã®ã‚«ãƒ¡ãƒ©ã€cam1 â†’ 2å°ç›®ã®ã‚«ãƒ¡ãƒ©ã€‚<br>
      - ç”»é¢ã‚µã‚¤ã‚ºã¯ (320, 240) ã«è¨­å®šã—ã¦å‡¦ç†ã‚’é«˜é€ŸåŒ–ã€‚<br>
      - ã‚«ãƒ¡ãƒ©èµ·å‹•å¾Œã« <code>time.sleep(1)</code> ã§1ç§’å¾…æ©Ÿã€‚<br>
      - 1å°ã ã‘ä½¿ç”¨ã™ã‚‹å ´åˆã¯ cam1 éƒ¨åˆ†ã‚’å‰Šé™¤å¯èƒ½ã€‚
    </li>

    <li>
      <strong>â‘¢ å‰å›ã®é€²è¡Œæ–¹å‘ã‚’è¦šãˆã‚‹</strong><br>
      - <code>last_direction</code>ï¼šå‰å›ãƒ­ãƒœãƒƒãƒˆãŒå‘ã„ã¦ã„ãŸæ–¹å‘ï¼ˆLEFT / RIGHT / CENTERï¼‰ã€‚<br>
      - <code>avoid_mode</code>ï¼šéšœå®³ç‰©å›é¿ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°ã€‚
    </li>

    <li>
      <strong>â‘£ é»’ã„ç·šã‚’è¦‹ã¤ã‘ã‚‹ä»•çµ„ã¿</strong><br>
      - ç”»åƒã‚’ HSV ã«å¤‰æ›ã—ã€é»’è‰²éƒ¨åˆ†ã‚’æŠ½å‡ºã€‚<br>
      - ã¼ã‹ã—å‡¦ç†ã§ãƒã‚¤ã‚ºã‚’ä½æ¸›ã€‚<br>
      - ROIï¼ˆä¸‹40ãƒ”ã‚¯ã‚»ãƒ«ï¼‰ã ã‘ã‚’å‡¦ç†ã—ã¦é€Ÿåº¦ã¨ç²¾åº¦ã‚’å‘ä¸Šã€‚<br>
      - <code>cv2.findContours</code> ã§è¼ªéƒ­ã‚’æ¤œå‡ºã—ã€é‡å¿ƒ (cx) ã‚’è¨ˆç®—ã€‚<br>
      - åˆ¤å®šçµæœï¼šç·šãŒå·¦ â†’ "LEFT"ã€ç·šãŒå³ â†’ "RIGHT"ã€ä¸­å¤® â†’ "CENTER"ã€è¦‹ãˆãªã„å ´åˆ â†’ å‰å›ã®æ–¹å‘ã‚’ç¶­æŒã€‚
    </li>

    <li>
      <strong>â‘¤ ãƒ¢ãƒ¼ã‚¿ãƒ¼ã§èµ°è¡Œã‚’åˆ¶å¾¡</strong><br>
      - é»’ç·šæ–¹å‘ã«å¿œã˜ã¦å·¦å³ãƒ¢ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦ã‚’èª¿æ•´ã€‚<br>
      - CENTER â†’ å·¦å³åŒã˜é€Ÿåº¦ã€LEFT â†’ å³ãƒ¢ãƒ¼ã‚¿ãƒ¼é€Ÿãã—ã¦å·¦ã¸æ›²ãŒã‚‹ã€RIGHT â†’ å·¦ãƒ¢ãƒ¼ã‚¿ãƒ¼é€Ÿãã—ã¦å³ã¸æ›²ãŒã‚‹ã€‚<br>
      - <code>base</code>ï¼ˆåŸºæœ¬é€Ÿåº¦ï¼‰ã¨ <code>diff</code>ï¼ˆå·¦å³å·®ï¼‰ã§æ›²ãŒã‚Šå…·åˆã‚’åˆ¶å¾¡ã€‚
    </li>

    <li>
      <strong>â‘¥ éšœå®³ç‰©å›é¿</strong><br>
      - è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼ã§å‰æ–¹éšœå®³ç‰©ã‚’æ¤œçŸ¥ã€‚<br>
      - è·é›¢270mmä»¥å†… â†’ <code>avoid_mode = True</code>ã€‚<br>
      - å·¦å³ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®é€Ÿåº¦ã‚’å¤‰ãˆã¦éšœå®³ç‰©ã‚’è¿‚å›ã€‚<br>
      - å›é¿å®Œäº†å¾Œ â†’ <code>avoid_mode = False</code> ã«ã—ã¦é€šå¸¸èµ°è¡Œã«æˆ»ã™ã€‚
    </li>

    <li>
      <strong>â‘¦ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œæ–¹æ³•</strong><br>
      - ãƒ¢ãƒ¼ã‚¿ãƒ¼ã¨ã‚»ãƒ³ã‚µãƒ¼ã‚’ç™»éŒ²ï¼ˆadd_deviceï¼‰ã€‚<br>
      - ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹é–¢æ•°ã‚’ç™»éŒ²ï¼ˆadd_handlerï¼‰ã€‚<br>
      - 0.05ç§’ã”ã¨ã«å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã™ï¼ˆdispatch(interval=0.05)ï¼‰ã€‚<br>
      â†’ ãƒ­ãƒœãƒƒãƒˆãŒã‚«ãƒ¡ãƒ©ã§é»’ç·šã‚’èªè­˜ã—ã€éšœå®³ç‰©ã‚’é¿ã‘ãªãŒã‚‰è‡ªå¾‹èµ°è¡Œã€‚
    </li>
  </ol>
</div>


<div class="learn-section">
  <h2>ğŸ“˜ å­¦ç¿’ã®ã‚„ã‚Šæ–¹</h2>
  <p>éšœå®³ç‰©ã®å­¦ç¿’ã§ã¯ã€æ¬¡ã®æ‰‹é †ã§ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚</p>
  <ol class="learn-list">
    <li>ã‚«ãƒ¡ãƒ©ã§åºŠã®é»’ç·šã‚’æ¢ã™</li>
    <li>ç·šã®ä½ç½®ã‹ã‚‰å·¦å³ã©ã¡ã‚‰ã«æ›²ãŒã‚‹ã‹åˆ¤æ–­ã™ã‚‹</li>
    <li>ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®é€Ÿåº¦ã‚’èª¿æ•´ã—ã¦æ–¹å‘è»¢æ›</li>
    <li>è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼ã§éšœå®³ç‰©ã‚’æ¤œçŸ¥ â†’ å›é¿</li>
    <li>ã“ã®å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã™ â†’ ãƒ­ãƒœãƒƒãƒˆãŒè‡ªå¾‹èµ°è¡Œ</li>
  </ol>
  <p>å®Ÿéš›ã«ãƒ­ãƒœãƒƒãƒˆã‚’å‹•ã‹ã—ãªãŒã‚‰å­¦ã¶ã“ã¨ã§ã€<strong>ã€Œã‚»ãƒ³ã‚µãƒ¼ã€ã¨ã€Œã‚«ãƒ¡ãƒ©ã€ã®é–¢ä¿‚</strong>ã‚’æ·±ãç†è§£ã§ãã¾ã™ã€‚</p>
</div>


  </main>

</body>
</html>
