<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ゴールタイル</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* ▼ 学習セクション ▼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }


        footer {
      text-align:center;
      padding:20px;
      background-color:#ecf0f1;
      margin-top:20px;
      border-radius:6px;
    }


        /* サイドバーを左に固定 */
.sidebar {
  position: fixed;       /* 画面に固定 */
  top: 0;                /* 上から0 */
  left: 0;               /* 左から0 */
  height: 100%;          /* 画面の高さいっぱい */
  width: 250px;          /* サイドバーの幅 */
  background-color: #ecf0f1;
  padding: 20px;
  box-shadow: 2px 0 8px rgba(0,0,0,0.1);
  overflow-y: auto;      /* 高さオーバーしたらスクロール */
  transform: translateX(-100%); /* 初期は画面外に隠す */
  transition: transform 0.3s ease;
  z-index: 1000;
}

/* 開いた状態 */
.sidebar.open {
  transform: translateX(0);
}

/* ハンバーガー位置調整 */
.menu-icon {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1100;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.menu-icon div {
  width: 30px;
  height: 4px;
  background-color: #e3f2fd;
  border-radius: 2px;
}


         /* 右上の次へボタン */
    #nextButton {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      z-index: 2000;
      transition: 0.3s;
    }

    #nextButton:hover {
      background-color: #2980b9;
    }

            .tips-grid {
  display: flex;          /* 横並びにする */
  flex-wrap: wrap;        /* 画面幅に合わせて折り返す */
  gap: 16px;              /* ボックス間の隙間 */
}


  </style>
</head>
<body>


  <div class="wrapper">

  <!-- ハンバーガー -->
  <div class="menu-icon" id="menuIcon" onclick="toggleMenu()">
    <div></div><div></div><div></div>
  </div>

  <!-- サイドバー -->
  <nav class="sidebar" id="sidebar">
    <ul>
      <li>
        <details>
          <summary>はじめに</summary>
          <ul>
            <li><a href="robocup_home.html">ロボカップジュニアについて</a></li>
          </ul>
        </details>
      </li>
      <li>
        <details>
          <summary>1. ルール</summary>
          <ul>
            <li><a href="gaiyou.html">概要</a></li>
            <li><a href="koudoukihann.html">行動規範</a></li>
            <li><a href="field.html">フィールド</a></li>
            <li><a href="robot.html">ロボット</a></li>
            <li><a href="kyougi.html" style="color:#3498db;">競技</a></li>
          </ul>
        </details>
      </li>
      <li>
        <details>
          <summary>2. 実践</summary>
          <ul>
            <li><a href="linetrace.html">白黒ライントレース</a></li>
            <li><a href="linetrace2.html">交差点付きライントレース</a></li>
            <li><a href="linetrace3.html">ギャップライントレース</a></li>
            <li><a href="goal.html">ゴールタイル</a></li>
            <li><a href="speedbump.html">スピードバンプ</a></li>
            <li><a href="syougaibutu.html">障害物</a></li>
            <li><a href="gareki.html">瓦礫</a></li>
            <li><a href="seesaw.html">シーソー</a></li>
            <li><a href="keisyaro.html">傾斜路</a></li>
            <li><a href="ball1.html">ボール検知の学習</a></li>
            <li><a href="blackball.html">黒色ボール</a></li>
            <li><a href="silverball.html">銀色ボール</a></li>
          </ul>
        </details>
      </li>
    </ul>
  </nav>

  <!-- 右上固定 次へボタン -->
  <a href="speedbanmp.html" id="nextButton">次へ →</a>

  <header>
    <h1>ゴールタイル</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ホーム</a>
    <a href="linetrace.html">白黒ライントレース</a>
    <a href="linetrace2.html">交差点付きライントレース</a>
    <a href="linetrace3.html">ギャップライントレース</a>
  </nav>

  <main>
    <video controls>
      <source src="linetrace.mp4" type="video/mp4">
      お使いのブラウザは動画再生に対応していません。
    </video>
    <div class="caption">
      ロボットが黒いラインに沿って正確に走行する様子を撮影した動画です。
    </div>

    <h2>coler_red_only.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code># =========================================
# 🔹 ライントレース＋赤・緑検知ストッププログラム
# 使用デバイス：ETRobo（SPIKE対応）
# 機能概要：
#   - カラーセンサーでラインを検出して走行
#   - 赤または緑を検出すると5秒間停止
#   - HSV色空間を用いて色を判定
# =========================================

import cv2
import numpy as np
from etrobo_python import ETRobo, Motor, ColorSensor
import time

# --- 直前の進行方向を記録するための変数 ---
last_direction = "RIGHT"  # 初期値は右

# =========================================
# 🔹 関数：get_hsv_from_sensor
# 概要：
#   - カラーセンサーからRGB値を取得
#   - OpenCVを使ってHSV値に変換
# 引数：
#   - color_sensor: ColorSensorオブジェクト
# 戻り値：
#   - (H, S, V) のタプル
# =========================================

# ② センサーのRGBをHSVに変換する関数
def get_hsv_from_sensor(color_sensor: ColorSensor):
    # カラーセンサーからRGB値を取得
    r, g, b = color_sensor.get_raw_color()
    # OpenCVで扱える形式に変換（3次元配列）
    rgb = np.uint8([[[r, g, b]]])
    # RGB → HSV変換
    hsv = cv2.cvtColor(rgb, cv2.COLOR_RGB2HSV)
    # H, S, Vの値を返す
    return hsv[0][0]

# =========================================
# 🔹 関数：line_trace_by_sensor
# 概要：
#   - カラーセンサーでラインを追跡しながら走行
#   - 赤または緑を検知したら停止
#   - 白・黒の明度（V値）でラインの有無を判定
# 引数：
#   - right_motor: 右モーター
#   - left_motor: 左モーター
#   - color_sensor: カラーセンサー
# =========================================

# ③ ラインを追跡したり、色を判定したりする関数
def line_trace_by_sensor(right_motor: Motor, left_motor: Motor, color_sensor: ColorSensor):
    global last_direction  # 直前の方向を保持するためグローバル変数を使用

    try:
        # ③-1. HSV値の取得
        h, s, v = get_hsv_from_sensor(color_sensor)

        # ③-2. 赤色の判定
        # --- 赤色検知条件 ---
        # 色相(H)：0〜10 または 160〜180
        # 彩度(S)：100以上
        # 明度(V)：100以上
        is_red = (0 <= h <= 10 or 160 <= h <= 180) and s >= 100 and v >= 100

        # ③-3. 緑色の判定
        # --- 緑色検知条件 ---
        # 色相(H)：50〜90
        # 彩度・明度：100以上
        is_green = 50 <= h <= 90 and s >= 100 and v >= 100

        # ③-4. 赤 or 緑を見つけたら停止
        # --- 赤または緑を検知した場合 ---
        if is_red or is_green:
            print(f"[STOP] {'Red' if is_red else 'Green'} detected! HSV=({h}, {s}, {v})")
            # 両モーター停止
            right_motor.set_power(0)
            left_motor.set_power(0)
            # 5秒間停止
            time.sleep(5)

        # ③-5. ライン（黒）を見つけた場合
        # --- ライン上（黒っぽい領域）を検知した場合 ---
        elif v < 60 and s < 100:
            # 直進動作
            power = 40
            right_motor.set_power(power)
            left_motor.set_power(power)
            last_direction = "STRAIGHT"

        # ③-6. ラインが見つからない（白地）なら旋回
        # --- 白地など明るい場所の場合 ---
        else:
            # 前回の進行方向に応じて旋回
            if last_direction in ["STRAIGHT", "RIGHT"]:
                # 左に旋回
                right_motor.set_power(0)
                left_motor.set_power(30)
                last_direction = "LEFT"
            else:
                # 右に旋回
                right_motor.set_power(30)
                left_motor.set_power(0)
                last_direction = "RIGHT"

        # HSV値と方向のログを表示
        print(f"HSV: H={h}, S={s}, V={v}, Dir={last_direction}")

    except Exception as e:
        # エラー発生時の出力
        print("Error in sensor line trace:", e)

# =========================================
# 🔹 メイン処理
# 概要：
#   - ETRobo環境を初期化
#   - デバイス（モーター・カラーセンサー）を登録
#   - line_trace_by_sensor 関数を周期的に呼び出し
# =========================================

# ④ ロボットのデバイス登録（初期設定）
(
    ETRobo(backend='raspyke')  # SPIKE用バックエンド
    .add_device('right_motor', device_type=Motor, port='B')  # 右モーターをポートBに接続
    .add_device('left_motor', device_type=Motor, port='C')   # 左モーターをポートCに接続
    .add_device('color_sensor', device_type=ColorSensor, port='S2')  # カラーセンサーをS2に接続
    # ⑤ メインループの開始
    .add_handler(line_trace_by_sensor)  # 定期的に呼び出す関数を登録
    .dispatch(interval=0.1)  # 0.1秒ごとに実行
)
</code>
</code></pre>
      </div>

      <div class="desc-box">
  <h3>（プログラムの説明）</h3>
  <p><b>① プログラムの目的：</b><br>
    このプログラムは、ETRobo（SPIKE対応ロボット）を使って、<br>
    ・ラインを追いかけて走る<br>
    ・赤または緑を見つけたら5秒停止する<br>
    ・ライン（黒）の明るさ（V値）で線を判断する<br>
    ・RGBをHSVへ変換して色判定を行う<br>
    という複数の動きをまとめて制御するためのものです。
  </p>

  <p><b>② RGB → HSV に変換する関数：</b><br>
    カラーセンサーから取得したRGB値をOpenCVでHSVに変換します。<br>
    HSVを使う理由は、特に「色相（H）」が赤や緑の識別に適しており、<br>
    センサーの色判断が安定しやすくなるためです。
  </p>

  <p><b>③ ライン追跡・色判定を行うメイン関数：</b><br>
    ロボットの中心的な動作を担当する部分です。以下の流れで動作します。
  </p>

  <p><b>③-1. HSV値の取得：</b> センサーからRGBを読み取り、HSVに変換します。</p>

  <p><b>③-2. 赤色の判定：</b><br>
    ・H：0〜10 または 160〜180<br>
    ・S：100以上<br>
    ・V：100以上<br>
    これらの条件を満たすと赤と判断します。
  </p>

  <p><b>③-3. 緑色の判定：</b><br>
    ・H：50〜90<br>
    ・S、V：100以上<br>
    これらの条件で緑と判断します。
  </p>

  <p><b>③-4. 赤または緑を検出した場合：</b><br>
    ・モーターを停止<br>
    ・5秒間停止<br>
    という処理を行います。
  </p>

  <p><b>③-5. ライン（黒）を検出した場合：</b><br>
    ・V（明度）が低い<br>
    ・S（彩度）も低い<br>
    という特徴から「黒＝ライン上」と判断し、ロボットはまっすぐ進みます。
  </p>

  <p><b>③-6. ラインが見つからない（白地）の場合：</b><br>
    前回の進行方向（右 or 左）を記録しておき、<br>
    その方向を基準に旋回してラインを探します。<br>
    ・前回が右なら → 今回は左へ旋回<br>
    ・前回が左なら → 今回は右へ旋回
  </p>

  <p><b>④ ロボットのデバイス登録：</b><br>
    この部分では、ロボットに接続しているデバイスを設定します。<br>
    ・右モーター（Bポート）<br>
    ・左モーター（Cポート）<br>
    ・カラーセンサー（S2ポート）<br>
    の3つを登録しています。
  </p>

  <p><b>⑤ メインループの開始：</b><br>
    0.1秒ごとに line_trace_by_sensor を実行します。<br>
    これによりロボットは、<br>
    ・色を読む<br>
    ・ラインを判断<br>
    ・赤・緑チェック<br>
    ・モーター制御<br>
    を自動で繰り返し、走行し続けます。
  </p>
</div>

<div class="tips-section">
  <h2>よくある問題と改善のヒント</h2>
  <div class="tips-grid">

    <article class="desc-box">
      <h3>🚦 ゴールタイルが正しく検知されない</h3>
      <p>・明度や照明の影響でゴールタイル色が正しく判定されない<br>・HSV閾値が環境に合っていない<br>・<code>v</code> や <code>s</code> の範囲を調整</p>
      <p style="color:#16a34a; font-weight:600;">🌱 HSVの閾値を見直そう！</p>
    </article>

    <article class="desc-box">
      <h3>🕹️ ライン追跡が不安定</h3>
      <p>・ラインを外したときに復帰が遅い<br>・旋回幅や方向が環境によって合わない<br>・前回方向（<code>last_direction</code>）を活用して補正</p>
      <p style="color:#2b7bd3; font-weight:600;">⚙️ 前回方向で補正しよう！</p>
    </article>

    <article class="desc-box">
      <h3>🖤 黒ラインが正しく認識されない</h3>
      <p>・明度Vと彩度Sの閾値が適切でない<br>・影や照明変化で誤判定<br>・<code>v < 60 and s < 100</code> を環境に合わせて調整</p>
      <p style="color:#16a34a; font-weight:600;">🎨 ライン判定の閾値を調整しよう！</p>
    </article>

    <article class="desc-box">
      <h3>↔️ 旋回方向がおかしい／ゴールタイル通過後の停止がずれる</h3>
      <p>・モーター接続や左右割り当てが間違っている<br>・コード内の旋回処理や停止判定位置を確認<br>・センサー配線と出力方向をチェック</p>
      <p style="color:#2b7bd3; font-weight:600;">🧭 旋回方向と停止判定を確認しよう！</p>
    </article>

    <article class="desc-box">
      <h3>⏱️ 停止タイミングが早すぎる／遅すぎる</h3>
      <p>・ゴールタイル上での停止時間や距離が合っていない<br>・<code>time.sleep()</code> やモーター出力の調整が必要</p>
      <p style="color:#16a34a; font-weight:600;">⏳ 停止位置・時間を微調整しよう！</p>
    </article>

  </div>
</div>


    <!-- ▼ 学習のやり方セクション ▼ -->
    <div class="learn-section">
      <h2>📘 学習のやり方</h2>
      <p>ゴールタイルの学習では、次の手順で理解を深めていきましょう。</p>

      <ol class="learn-list">
        <li><b>動作の確認：</b> まずはロボットがゴールタイルをどのように検出し、
            停止または動作を切り替えているかを動画で確認します。</li>

        <li><b>コードの理解：</b> ゴールタイル判定ロジック（色のしきい値判定・HSV変換・
            検出位置の範囲など）を順番に読み解きます。</li>

        <li><b>実験と調整：</b> ゴールタイルの明るさや環境光によって検出精度が変わるため、
            HSVの上下限値を変更してどの設定が最も安定するか試します。</li>

        <li><b>応用：</b> ゴールタイル到達後の行動（停止、向きの変更、次の処理へ進むなど）を
            自由にカスタマイズしてみましょう。</li>
      </ol>

      <p>実際にロボットを動かして環境を変えながら学ぶことで、画像処理による判定の仕組みや、
        しきい値調整の大切さをより深く理解できます。</p>
    </div>


  </main>


  
      <footer>
      <p>&copy; 2025　愛知工業大学　水野勝教研究室 </p>
    </footer>


    <script>
  function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const menuIcon = document.getElementById('menuIcon');
    sidebar.classList.toggle('open');
    menuIcon.classList.toggle('open');
  }

  document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const menuIcon = document.getElementById('menuIcon');
    if (!e.target.closest('.sidebar') && !e.target.closest('.menu-icon') && sidebar.classList.contains('open')) {
      sidebar.classList.remove('open');
      menuIcon.classList.remove('open');
    }
  });
</script>

</body>
</html>
