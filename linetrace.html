<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™½é»’ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* â–¼ å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

    /* â–¼ ã‚ˆãã‚ã‚‹å•é¡Œã‚«ãƒ¼ãƒ‰ â–¼ */
    .tips-section {
      margin-top:50px;
      padding:20px;
      background-color:#f7f9fb;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }

    .tips-section h2 {
      color:#3498db; 
      font-size:1.8em; 
      margin-bottom:20px; 
      width:100%; 
      display:block;
    }

    .tips-grid {
      display:grid; 
      grid-template-columns:repeat(4, 1fr); 
      gap:12px;
    }

    .card {
      background:#fff; 
      border:1px solid #e6eef9; 
      border-radius:10px; 
      padding:14px; 
      box-shadow:0 4px 12px rgba(43,123,211,0.08); 
      font-size:13px;
    }

    .card h3 {
      display:flex; 
      align-items:center; 
      font-size:14px; 
      margin:0 0 8px 0; 
      background:#e3f2fd; 
      color:#000; 
      padding:6px 8px; 
      border-radius:6px;
    }

    .card p {
      margin-top:6px;
    }

    @media screen and (max-width: 1200px) {
      .tips-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media screen and (max-width: 600px) {
      .tips-grid {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>
<body>

  <header>
    <h1>ç™½é»’ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="linetrace2.html">äº¤å·®ç‚¹ä»˜ããƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</a>
    <a href="linetrace3.html">ã‚®ãƒ£ãƒƒãƒ—ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</a>
    <a href="goal.html">ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ«</a>
  </nav>

  <main>
    <video controls>
      <source src="linetrace.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
      ãƒ­ãƒœãƒƒãƒˆãŒé»’ã„ãƒ©ã‚¤ãƒ³ã«æ²¿ã£ã¦æ­£ç¢ºã«èµ°è¡Œã™ã‚‹æ§˜å­ã‚’æ’®å½±ã—ãŸå‹•ç”»ã§ã™ã€‚
    </div>

    <h2>linetrace.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code># OpenCVãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ç”»åƒå‡¦ç†ã‚’è¡Œã†ãŸã‚ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import cv2
import numpy as np
from picamera2 import Picamera2
from etrobo_python import ETRobo, Motor
import time

# ã‚«ãƒ¡ãƒ©ã®è¨­å®š
cam0 = Picamera2(0)
cam0.configure(cam0.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam0.start()
time.sleep(1)

# å‰å›ã®æ–¹å‘ã‚’è¨˜æ†¶
last_direction = "CENTER"

# é»’ã„ç·šã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
def get_direction(frame, last_direction):
    hsv = cv2.cvtColor(frame, cv2.COLOR_RGB2HSV)
    lower_black = (0, 0, 0)
    upper_black = (180, 255, 80)
    mask = cv2.inRange(hsv, lower_black, upper_black)
    mask = cv2.GaussianBlur(mask, (5, 5), 0)
    height, width = mask.shape
    roi_bottom = mask[height-40:height, :]
    contours, _ = cv2.findContours(roi_bottom, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    direction = last_direction
    if contours:
        cx = np.mean([cv2.moments(c)["m10"]/cv2.moments(c)["m00"] for c in contours if cv2.moments(c)["m00"] != 0])
        if cx < width//2 - 20:
            direction = "LEFT"
        elif cx > width//2 + 20:
            direction = "RIGHT"
        else:
            direction = "CENTER"
    return direction

# ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’å‹•ã‹ã™é–¢æ•°
def line_trace_by_camera(right_motor: Motor, left_motor: Motor, **kwargs):
    global last_direction
    try:
        frame0 = cam0.capture_array()
        direction = get_direction(frame0, last_direction)
        last_direction = direction
        print("é€²è¡Œæ–¹å‘:", direction)
        base_speed = 90 if direction == "CENTER" else 50
        diff = 55
        if direction == "LEFT":
            right_motor.set_power(base_speed + diff)
            left_motor.set_power(base_speed - diff)
        elif direction == "RIGHT":
            right_motor.set_power(base_speed - diff)
            left_motor.set_power(base_speed + diff)
        else:
            right_motor.set_power(base_speed)
            left_motor.set_power(base_speed)
    except Exception as e:
        print("ã‚¨ãƒ©ãƒ¼:", e)

# ãƒ¡ã‚¤ãƒ³
if __name__ == "__main__":
    robo = (ETRobo(backend='raspike_art')
            .add_device('right_motor', device_type=Motor, port='A')
            .add_device('left_motor', device_type=Motor, port='B')
            .add_handler(line_trace_by_camera))
    robo.dispatch(interval=0.05)
</code></pre>
      </div>
      <div class="desc-box">
        <h3>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜</h3>
        <p>ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ã‚«ãƒ¡ãƒ©ã§é»’ã„ç·šã‚’èªè­˜ã—ã¦ãƒ­ãƒœãƒƒãƒˆã‚’è‡ªå‹•èµ°è¡Œã•ã›ã‚‹ã‚‚ã®ã§ã™ã€‚ç”»åƒå‡¦ç†ã§é»’ç·šã®ä½ç½®ã‚’åˆ¤å®šã—ã€ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®å·¦å³é€Ÿåº¦ã‚’èª¿æ•´ã—ã¦é€²è¡Œæ–¹å‘ã‚’æ±ºå®šã—ã¾ã™ã€‚</p>
        <ul>
          <li><b>cv2, numpy:</b> ç”»åƒå‡¦ç†ãƒ»è¨ˆç®—ç”¨</li>
          <li><b>Picamera2:</b> ã‚«ãƒ¡ãƒ©æ“ä½œ</li>
          <li><b>ETRobo / Motor:</b> ãƒ­ãƒœãƒƒãƒˆåˆ¶å¾¡</li>
          <li><b>time:</b> ã‚«ãƒ¡ãƒ©å®‰å®šå¾…æ©Ÿç”¨</li>
        </ul>
        <p>ç”»åƒå‡¦ç†ã®æµã‚Œï¼šRGBâ†’HSVå¤‰æ› â†’ é»’è‰²æŠ½å‡º â†’ ä¸‹éƒ¨40pxã‚’ROI â†’ è¼ªéƒ­æ¤œå‡º â†’ ä¸­å¿ƒåº§æ¨™ã§æ–¹å‘æ±ºå®š</p>
        <p>ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡ï¼šæ–¹å‘ã«å¿œã˜ã¦å·¦å³é€Ÿåº¦ã‚’å¤‰æ›´ã€ä¸­å¤®ãªã‚‰åŸºæœ¬é€Ÿåº¦ã€å·¦å³ãªã‚‰å·®åˆ†ã‚’åŠ æ¸›ã—ã¦æ—‹å›ã€‚</p>
      </div>
    </div>

    <!-- â–¼ ã‚ˆãã‚ã‚‹å•é¡Œã¨æ”¹å–„ã®ãƒ’ãƒ³ãƒˆ â–¼ -->
    <div class="tips-section">
      <h2>ã‚ˆãã‚ã‚‹å•é¡Œã¨æ”¹å–„ã®ãƒ’ãƒ³ãƒˆ</h2>
      <div class="tips-grid">
        <article class="card">
          <h3>ğŸš— ã¾ã£ã™ãé€²ã¾ãªã„</h3>
          <p>ãƒ»å·¦å³ã®ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®å‡ºåŠ›ãŒåŒã˜ã‹ç¢ºèª<br>ãƒ»ã‚¿ã‚¤ãƒ¤ã®æ‘©è€—ã§é€²è¡Œæ–¹å‘ãŒãšã‚Œã‚‹<br>ãƒ»<code>base_speed</code> ã‚’èª¿æ•´</p>
          <p style="color:#16a34a; font-weight:600;">âš™ï¸ ãƒãƒ©ãƒ³ã‚¹ã‚’å¾®èª¿æ•´ï¼</p>
        </article>
        <article class="card">
          <h3>ğŸ•³ï¸ ç·šã‚’è¦‹å¤±ã†</h3>
          <p>ãƒ»ã‚«ãƒ¡ãƒ©ã®é«˜ã•ã‚„è§’åº¦ã‚’èª¿æ•´<br>ãƒ»<code>roi_bottom</code> ã®ç¯„å›²ã‚’åºƒã’ã‚‹<br>ãƒ»æ˜ã‚‹ã•ã‚’ä¸Šã’ã‚‹ï¼ãƒ©ã‚¤ãƒˆä½¿ç”¨</p>
          <p style="color:#2b7bd3; font-weight:600;">ğŸ” ã‚«ãƒ¡ãƒ©ãƒ»æ˜ã‚‹ã•ã‚’èª¿æ•´ï¼</p>
        </article>
        <article class="card">
          <h3>âš« é–“é•ã£ãŸå ´æ‰€ã‚’é»’ã¨åˆ¤å®š</h3>
          <p>ãƒ»é»’ã®ã—ãã„å€¤ãŒåºƒã™ãã‚‹<br>ãƒ»å½±ã‚„æš—ã„éƒ¨åˆ†ã‚‚é»’ã¨èªè­˜<br>ãƒ»HSVå€¤ã‚’å¾®èª¿æ•´ã—ã¦æ­£ã—ã„é»’ã‚’æ¤œå‡º</p>
          <p style="color:#16a34a; font-weight:600;">ğŸ¨ ã—ãã„å€¤ã‚’èª¿æ•´ï¼</p>
        </article>
        <article class="card">
          <h3>â†”ï¸ å·¦å³ãŒé€†ã«ãªã‚‹</h3>
          <p>ãƒ»ã‚«ãƒ¡ãƒ©æ˜ åƒãŒå·¦å³åè»¢<br>ãƒ»OpenCVã§ <code>cv2.flip(frame,1)</code> ä½¿ç”¨<br>ãƒ»ãƒ¢ãƒ¼ã‚¿ãƒ¼æ¥ç¶šï¼ˆAãƒ»Bï¼‰ç¢ºèª</p>
          <p style="color:#2b7bd3; font-weight:600;">ğŸ§­ æ˜ åƒã¨æ¥ç¶šã‚’ãƒã‚§ãƒƒã‚¯ï¼</p>
        </article>
      </div>
    </div>

    <!-- â–¼ å­¦ç¿’ã®ã‚„ã‚Šæ–¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ -->
    <div class="learn-section">
      <h2>ğŸ“˜ å­¦ç¿’ã®ã‚„ã‚Šæ–¹</h2>
      <p>ç™½é»’ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ã®å­¦ç¿’ã§ã¯ã€æ¬¡ã®æ‰‹é †ã§ç†è§£ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚</p>
      <ol class="learn-list">
        <li><b>å‹•ä½œã®ç¢ºèªï¼š</b> å‹•ç”»ã‚’è¦‹ã¦ãƒ­ãƒœãƒƒãƒˆã®èµ°è¡Œã‚’è¦³å¯Ÿã€‚</li>
        <li><b>ã‚³ãƒ¼ãƒ‰ã®ç†è§£ï¼š</b> ã‚«ãƒ¡ãƒ©å–å¾—ãƒ»ç”»åƒå‡¦ç†ãƒ»ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡ã®æµã‚Œã‚’ç¢ºèªã€‚</li>
        <li><b>å®Ÿé¨“ã¨èª¿æ•´ï¼š</b> é»’ç·šã®å¤ªã•ã‚„ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’å¤‰ãˆã¦åå¿œã‚’ç¢ºèªã€‚</li>
        <li><b>å¿œç”¨ï¼š</b> é€Ÿåº¦ã‚„æ›²ãŒã‚Šå‡¦ç†ã€äº¤å·®ç‚¹å¯¾å¿œã®æ”¹è‰¯ã‚’è©¦ã™ã€‚</li>
      </ol>
      <p>å®Ÿéš›ã«ãƒ­ãƒœãƒƒãƒˆã‚’å‹•ã‹ã—ãªãŒã‚‰å­¦ã¶ã“ã¨ã§ã€ã‚»ãƒ³ã‚µãƒ¼ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ åˆ¶å¾¡ã®é–¢ä¿‚ã‚’æ·±ãç†è§£ã§ãã¾ã™ã€‚</p>
    </div>

  </main>
</body>
</html>
