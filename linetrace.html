<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>白黒ライントレース</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* ▼ 学習セクション ▼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

  </style>
</head>
<body>

  <header>
    <h1>白黒ライントレース</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ホーム</a>
    <a href="linetrace2.html">交差点付きライントレース</a>
    <a href="linetrace3.html">ギャップライントレース</a>
    <a href="goal.html">ゴールタイル</a>
  </nav>

  <main>
    <video controls>
      <source src="linetrace.mp4" type="video/mp4">
      お使いのブラウザは動画再生に対応していません。
    </video>
    <div class="caption">
      ロボットが黒いラインに沿って正確に走行する様子を撮影した動画です。
    </div>

    <h2>linetrace.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code># OpenCVライブラリを使用して画像処理を行うためにインポート
import cv2
import numpy as np
from picamera2 import Picamera2
from etrobo_python import ETRobo, Motor
import time

cam0 = Picamera2(0)
cam0.configure(cam0.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam0.start()
time.sleep(1)

cam1 = Picamera2(1)
cam1.configure(cam1.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam1.start()
time.sleep(1)

last_direction = "CENTER"

def get_direction(frame, last_direction):
    hsv = cv2.cvtColor(frame, cv2.COLOR_RGB2HSV)
    lower_black = (0, 0, 0)
    upper_black = (180, 255, 80)
    mask = cv2.inRange(hsv, lower_black, upper_black)
    mask = cv2.GaussianBlur(mask, (5, 5), 0)
    height, width = mask.shape
    roi_bottom = mask[height-40:height, :]
    contours, _ = cv2.findContours(roi_bottom, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    direction = last_direction
    if contours:
        cx = np.mean([cv2.moments(c)["m10"]/cv2.moments(c)["m00"] for c in contours if cv2.moments(c)["m00"] != 0])
        if cx < width//2 - 20:
            direction = "LEFT"
        elif cx > width//2 + 20:
            direction = "RIGHT"
        else:
            direction = "CENTER"
    return direction

def line_trace_by_camera(right_motor: Motor, left_motor: Motor, **kwargs):
    global last_direction
    try:
        frame0 = cam0.capture_array()
        direction = get_direction(frame0, last_direction)
        last_direction = direction
        print("進行方向:", direction)
        base_speed = 90 if direction == "CENTER" else 50
        diff = 55
        if direction == "LEFT":
            right_motor.set_power(base_speed + diff)
            left_motor.set_power(base_speed - diff)
        elif direction == "RIGHT":
            right_motor.set_power(base_speed - diff)
            left_motor.set_power(base_speed + diff)
        else:
            right_motor.set_power(base_speed)
            left_motor.set_power(base_speed)
    except Exception as e:
        print("エラー:", e)

if __name__ == "__main__":
    robo = (ETRobo(backend='raspike_art')
            .add_device('right_motor', device_type=Motor, port='A')
            .add_device('left_motor', device_type=Motor, port='B')
            .add_handler(line_trace_by_camera))
    robo.dispatch(interval=0.05)
</code></pre>
      </div>

<div class="desc-box">
  <h3>(プログラムの説明)</h3>
  <p>このプログラムは、「カメラで黒い線（ライン）を見つけて、その線に沿ってロボットを走らせる」ものです。Raspberry Pi に接続されたカメラで床の映像を取り込み、画像処理を使って黒い線の位置を調べ、ロボットのモーターを左右で調整しながら進行方向を決めています。</p>

  <h4>① 最初の部分（ライブラリの読み込み）</h4>
  <p>ここでは、必要な道具（ライブラリ）を使えるようにしています。</p>
  <ul>
    <li><b>cv2（OpenCV）</b>：画像を扱うためのライブラリです。色を変えたり、輪郭を見つけたりできます。</li>
    <li><b>numpy（np）</b>：数の計算を便利にするライブラリです。</li>
    <li><b>Picamera2</b>：Raspberry Pi に接続したカメラを操作します。</li>
    <li><b>ETRobo / Motor</b>：ロボットやモーターを制御するためのライブラリです。</li>
    <li><b>time</b>：少し待つ（スリープ）機能を使うために読み込んでいます。</li>
  </ul>

  <h4>② カメラの設定</h4>
  <p>ここでは、2台のカメラを設定しています。</p>
  <ul>
    <li><code>Picamera2(0)</code> は1台目のカメラ、<code>Picamera2(1)</code> は2台目のカメラです。</li>
    <li><code>size=(320, 240)</code> は画面の大きさ（解像度）で、画像処理を速くしています。</li>
    <li><code>time.sleep(1)</code> は「1秒待つ」という意味で、カメラが安定するまで待っています。</li>
  </ul>
  <p>※1台しかカメラを使っていない場合は、<code>cam1</code> の設定部分を削除しても動作します。</p>

  <h4>③ 前回の方向を記憶する変数</h4>
  <p>前回の進行方向（左・右・中央）を覚えておくための変数です。線を一時的に見失っても、最後の方向を思い出せるようにしています。</p>

  <h4>④ 黒い線を見つける関数（get_direction）</h4>
  <p>この関数では、カメラで撮った画像から黒い線の位置を見つけて、「線が左にあるか・中央にあるか・右にあるか」を判断しています。</p>

  <ol>
    <li><b>色の変換：</b> RGBからHSVに変換し、黒い部分を見やすくします。</li>
    <li><b>黒だけを取り出す：</b> 明るさが0〜80の部分だけを白くし、黒い線だけを抽出します。</li>
    <li><b>ぼかし処理：</b> <code>cv2.GaussianBlur</code> でノイズを減らして線を滑らかにします。</li>
    <li><b>画像の下部分だけを見る：</b> 下から40ピクセルを抽出（ROI）して処理速度と精度を上げます。</li>
    <li><b>輪郭を見つける：</b> <code>cv2.findContours</code> で黒い部分の形を検出します。</li>
    <li><b>重心を求める：</b> 黒い線の中央座標を計算して、左右どちらにあるか判断します。</li>
    <li><b>方向の決定：</b> 
      <ul>
        <li>中央より左 → "LEFT"</li>
        <li>中央より右 → "RIGHT"</li>
        <li>中央付近 → "CENTER"</li>
      </ul>
    </li>
  </ol>

  <h4>⑤ モーターを動かす関数</h4>
  <p>カメラで得た「方向情報」をもとに、ロボットのモーターを制御します。</p>
  <ul>
    <li><b>base_speed：</b> 基本速度（例：まっすぐ＝90、曲がる＝50）。</li>
    <li><b>diff：</b> 左右のモーターの差で曲がり角度を調整。</li>
    <li>右に線がある → 左モーターを速くする。左に線がある → 右モーターを速くする。</li>
  </ul>

  <h4>⑥ メインの部分（ロボットを動かす設定）</h4>
  <ul>
    <li><code>add_device</code>：右と左のモーターを登録。</li>
    <li><code>add_handler</code>：ライン追跡の関数を登録。</li>
    <li><code>dispatch(interval=0.05)</code>：0.05秒ごとに関数を呼び出して制御。</li>
  </ul>

  <p>これにより、ロボットはカメラの映像をもとにリアルタイムで黒線を追跡し、自動走行することができます。</p>
</div>

    <!-- ▼ 学習のやり方セクション ▼ -->
    <div class="learn-section">
      <h2>📘 学習のやり方</h2>
      <p>白黒ライントレースの学習では、次の手順で理解を深めましょう。</p>
      <ol class="learn-list">
        <li><b>動作の確認：</b> まずは動画を見て、ロボットがどのように黒線をたどるか観察します。</li>
        <li><b>コードの理解：</b> 各関数の役割（カメラ取得・画像処理・モーター制御）を順に読み解きます。</li>
        <li><b>実験と調整：</b> 黒線の太さやカメラの位置を変えて、プログラムの反応を試してみましょう。</li>
        <li><b>応用：</b> 速度やカーブ処理の調整、または交差点対応の改良などを行ってみます。</li>
      </ol>
      <p>実際にロボットを動かしながら学ぶことで、「センサー」と「プログラム制御」の関係を深く理解できます。</p>
    </div>

  </main>

</body>
</html>
