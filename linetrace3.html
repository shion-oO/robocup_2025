<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ギャップライントレース</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      margin-bottom: 60px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 400px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* ▼ 学習セクション ▼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

    /* トラブルシューティング全体 */
.trouble-section {
   display: flex;       /* 子要素を横並びにする */
  flex-wrap: wrap;     /* 画面幅が狭ければ折り返す */
  gap: 20px;  
}

.trouble-box-container {
  display: flex;       /* 子要素を横並びにする */
  flex-wrap: wrap;     /* 画面幅が狭ければ折り返す */
  gap: 20px;           /* ボックス同士の隙間 */
}

.trouble-box {
  flex: 1 1 300px;     /* 最小幅300px、余裕があれば横幅拡張 */
  background: #f7f9fb;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.trouble-box h3 {
  margin-top: 0;
  color: #3498db;
  font-size: 1.2em;
}


   /* サイドバーを左に固定 */
.sidebar {
  position: fixed;       /* 画面に固定 */
  top: 0;                /* 上から0 */
  left: 0;               /* 左から0 */
  height: 100%;          /* 画面の高さいっぱい */
  width: 250px;          /* サイドバーの幅 */
  background-color: #ecf0f1;
  padding: 20px;
  box-shadow: 2px 0 8px rgba(0,0,0,0.1);
  overflow-y: auto;      /* 高さオーバーしたらスクロール */
  transform: translateX(-100%); /* 初期は画面外に隠す */
  transition: transform 0.3s ease;
  z-index: 1000;
}

/* 開いた状態 */
.sidebar.open {
  transform: translateX(0);
}

/* ハンバーガー位置調整 */
.menu-icon {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1100;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.menu-icon div {
  width: 30px;
  height: 4px;
  background-color: #e3f2fd;
  border-radius: 2px;
}


         /* 右上の次へボタン */
    #nextButton {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      z-index: 2000;
      transition: 0.3s;
    }

    #nextButton:hover {
      background-color: #2980b9;
    }

        footer {
      text-align:center;
      padding:20px;
      background-color:#ecf0f1;
      margin-top:20px;
      border-radius:6px;
    }


  </style>
</head>
<body>


  
  <div class="wrapper">

  <!-- ハンバーガー -->
  <div class="menu-icon" id="menuIcon" onclick="toggleMenu()">
    <div></div><div></div><div></div>
  </div>

  <!-- サイドバー -->
  <nav class="sidebar" id="sidebar">
    <ul>
      <li>
        <details>
          <summary>はじめに</summary>
          <ul>
            <li><a href="robocup_home.html">ロボカップジュニアについて</a></li>
          </ul>
        </details>
      </li>
      <li>
        <details>
          <summary>1. ルール</summary>
          <ul>
            <li><a href="gaiyou.html">概要</a></li>
            <li><a href="koudoukihann.html">行動規範</a></li>
            <li><a href="field.html">フィールド</a></li>
            <li><a href="robot.html">ロボット</a></li>
            <li><a href="kyougi.html" style="color:#3498db;">競技</a></li>
          </ul>
        </details>
      </li>
      <li>
        <details>
          <summary>2. 実践</summary>
          <ul>
            <li><a href="linetrace.html">白黒ライントレース</a></li>
            <li><a href="linetrace2.html">交差点付きライントレース</a></li>
            <li><a href="linetrace3.html">ギャップライントレース</a></li>
            <li><a href="goal.html">ゴールタイル</a></li>
            <li><a href="speedbanmp.html">スピードバンプ</a></li>
            <li><a href="syougaibutu.html">障害物</a></li>
            <li><a href="gareki.html">瓦礫</a></li>
            <li><a href="seesaw.html">シーソー</a></li>
            <li><a href="keisyaro.html">傾斜路</a></li>
            <li><a href="ball1.html">ボール検知の学習</a></li>
            <li><a href="blackball.html">黒色ボール</a></li>
            <li><a href="silverball.html">銀色ボール</a></li>
          </ul>
        </details>
      </li>
    </ul>
  </nav>

    <!-- 右上固定 次へボタン -->
  <a href="goal.html" id="nextButton">次へ →</a>

  <header>
    <h1>ギャップライントレース</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ホーム</a>
    <a href="linetrace.html">白黒ライントレース</a>
    <a href="linetrace2.html">交差点付きライントレース</a>
    <a href="goal.html">ゴールタイル</a>
  </nav>

  <main>
    <video controls>
     <!-- <source src="linetrace.mp4" type="video/mp4"> -->
      <source src="jyuugi_aki.mp4" type="video/mp4"> 
      お使いのブラウザは動画再生に対応していません。
    </video>
    <div class="caption">
      <p>ロボットがギャップのあるラインに沿って走行する様子を撮影した動画です。
      <br>この走行は、白黒ライントレースと同じプログラムコードで実行しており、ギャップがあっても安定してラインを追従しています。
      <br>下のコードでは、ライントレースの基本的な処理の流れを示しています。
      <br>また、走行を安定させるための具体的な改善ヒントもまとめていますので、ぜひ参考にしてください。</p>

    </div>

    <h2>linetrace.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code># OpenCVライブラリを使用して画像処理を行うためにインポート

# ① 最初の部分（ライブラリの読み込み）
import cv2
import numpy as np
from picamera2 import Picamera2
from etrobo_python import ETRobo, Motor
import time

# ② カメラの設定
cam0 = Picamera2(0)
cam0.configure(cam0.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam0.start()
time.sleep(1)

cam1 = Picamera2(1)
cam1.configure(cam1.create_preview_configuration(main={"format": 'XRGB8888', "size": (320, 240)}))
cam1.start()
time.sleep(1)

# ③ 前回の方向を記憶する変数
last_direction = "CENTER"

# ④ 黒い線を見つける関数（get_direction）
def get_direction(frame, last_direction):
    hsv = cv2.cvtColor(frame, cv2.COLOR_RGB2HSV)
    lower_black = (0, 0, 0)
    upper_black = (180, 255, 80)
    mask = cv2.inRange(hsv, lower_black, upper_black)
    mask = cv2.GaussianBlur(mask, (5, 5), 0)
    height, width = mask.shape
    roi_bottom = mask[height-40:height, :]
    contours, _ = cv2.findContours(roi_bottom, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    direction = last_direction
    if contours:
        cx = np.mean([cv2.moments(c)["m10"]/cv2.moments(c)["m00"] for c in contours if cv2.moments(c)["m00"] != 0])
        if cx < width//2 - 20:
            direction = "LEFT"
        elif cx > width//2 + 20:
            direction = "RIGHT"
        else:
            direction = "CENTER"
    return direction

# ⑤ モーターを動かす関数
def line_trace_by_camera(right_motor: Motor, left_motor: Motor, **kwargs):
    global last_direction
    try:
        frame0 = cam0.capture_array()
        direction = get_direction(frame0, last_direction)
        last_direction = direction
        print("進行方向:", direction)
        base_speed = 90 if direction == "CENTER" else 50
        diff = 55
        if direction == "LEFT":
            right_motor.set_power(base_speed + diff)
            left_motor.set_power(base_speed - diff)
        elif direction == "RIGHT":
            right_motor.set_power(base_speed - diff)
            left_motor.set_power(base_speed + diff)
        else:
            right_motor.set_power(base_speed)
            left_motor.set_power(base_speed)
    except Exception as e:
        print("エラー:", e)

# ⑥ メインの部分（ロボットを動かす設定）
if __name__ == "__main__":
    robo = (ETRobo(backend='raspike_art')
            .add_device('right_motor', device_type=Motor, port='A')
            .add_device('left_motor', device_type=Motor, port='B')
            .add_handler(line_trace_by_camera))
    robo.dispatch(interval=0.05)
</code></pre>
      </div>

      <div class="desc-box">
        <h3>(プログラムの説明)</h3>
        <p>このプログラムは、「カメラで黒い線（ライン）を見つけて、その線に沿ってロボットを走らせる」ものです。Raspberry Pi に接続されたカメラで床の映像を取り込み、画像処理を使って黒い線の位置を調べ、ロボットのモーターを左右で調整しながら進行方向を決めています。</p>

  <h4>① 最初の部分（ライブラリの読み込み）</h4>
  <p>ここでは、必要な道具（ライブラリ）を使えるようにしています。</p>
  <ul>
    <li><b>cv2（OpenCV）</b>：画像を扱うためのライブラリです。色を変えたり、輪郭を見つけたりできます。</li>
    <li><b>numpy（np）</b>：数の計算を便利にするライブラリです。</li>
    <li><b>Picamera2</b>：Raspberry Pi に接続したカメラを操作します。</li>
    <li><b>ETRobo / Motor</b>：ロボットやモーターを制御するためのライブラリです。</li>
    <li><b>time</b>：少し待つ（スリープ）機能を使うために読み込んでいます。</li>
  </ul>

  <h4>② カメラの設定</h4>
  <p>ここでは、2台のカメラを設定しています。</p>
  <ul>
    <li><code>Picamera2(0)</code> は1台目のカメラ、<code>Picamera2(1)</code> は2台目のカメラです。</li>
    <li><code>size=(320, 240)</code> は画面の大きさ（解像度）で、画像処理を速くしています。</li>
    <li><code>time.sleep(1)</code> は「1秒待つ」という意味で、カメラが安定するまで待っています。</li>
  </ul>
  <p>※1台しかカメラを使っていない場合は、<code>cam1</code> の設定部分を削除しても動作します。</p>

  <h4>③ 前回の方向を記憶する変数</h4>
  <p>前回の進行方向（左・右・中央）を覚えておくための変数です。線を一時的に見失っても、最後の方向を思い出せるようにしています。</p>

  <h4>④ 黒い線を見つける関数（get_direction）</h4>
  <p>この関数では、カメラで撮った画像から黒い線の位置を見つけて、「線が左にあるか・中央にあるか・右にあるか」を判断しています。</p>

  <ol>
    <li><b>色の変換：</b> RGBからHSVに変換し、黒い部分を見やすくします。</li>
    <li><b>黒だけを取り出す：</b> 明るさが0〜80の部分だけを白くし、黒い線だけを抽出します。</li>
    <li><b>ぼかし処理：</b> <code>cv2.GaussianBlur</code> でノイズを減らして線を滑らかにします。</li>
    <li><b>画像の下部分だけを見る：</b> 下から40ピクセルを抽出（ROI）して処理速度と精度を上げます。</li>
    <li><b>輪郭を見つける：</b> <code>cv2.findContours</code> で黒い部分の形を検出します。</li>
    <li><b>重心を求める：</b> 黒い線の中央座標を計算して、左右どちらにあるか判断します。</li>
    <li><b>方向の決定：</b> 
      <ul>
        <li>中央より左 → "LEFT"</li>
        <li>中央より右 → "RIGHT"</li>
        <li>中央付近 → "CENTER"</li>
      </ul>
    </li>
  </ol>

  <h4>⑤ モーターを動かす関数</h4>
  <p>カメラで得た「方向情報」をもとに、ロボットのモーターを制御します。</p>
  <ul>
    <li><b>base_speed：</b> 基本速度（例：まっすぐ＝90、曲がる＝50）。</li>
    <li><b>diff：</b> 左右のモーターの差で曲がり角度を調整。</li>
    <li>右に線がある → 左モーターを速くする。左に線がある → 右モーターを速くする。</li>
  </ul>

  <h4>⑥ メインの部分（ロボットを動かす設定）</h4>
  <ul>
    <li><code>add_device</code>：右と左のモーターを登録。</li>
    <li><code>add_handler</code>：ライン追跡の関数を登録。</li>
    <li><code>dispatch(interval=0.05)</code>：0.05秒ごとに関数を呼び出して制御。</li>
  </ul>

  <p>これにより、ロボットはカメラの映像をもとにリアルタイムで黒線を追跡し、自動走行することができます。</p>
</div>
    </div>

    <main>

<section id="troubleshooting">
  <h2>📌 よくある問題とヒント</h2>

  <div class="trouble-box-container">

  <!-- ① カメラが起動しない -->
  <div class="trouble-box">
    <h3>① 📷 カメラが起動しない</h3>
    <p>起動時に <code>RuntimeError</code> や <code>Device not found</code> が出る場合…</p>
    <ul>
      <li>🔌 ケーブルの接続を再確認</li>
      <li>🧪 <code>libcamera-hello</code> を実行してカメラ認識テスト</li>
      <li>🔄 Raspberry Pi を再起動</li>
    </ul>
    <p style="color:#16a34a; font-weight:600;">💡 一番多い原因は「ケーブルの向きミス」だよ！</p>
  </div>

  <!-- ② 2つ目のカメラが映らない -->
  <div class="trouble-box">
    <h3>② 🎥 2つ目のカメラが映らない</h3>
    <p>cam0 と cam1 の割り当てが逆になっている可能性📌</p>
    <ul>
      <li>🔁 ケーブル接続位置の左右・上下を再チェック</li>
      <li>🧭 Picamera2(0) と Picamera2(1) の番号を入れ替えてテスト</li>
    </ul>
    <p style="color:#2b7bd3; font-weight:600;">🔍 カメラ順番の確認がポイント！</p>
  </div>

  <!-- ③ 黒ラインを見失う -->
  <div class="trouble-box">
    <h3>③ 🖤 黒ラインを見失う</h3>
    <ul>
      <li>💡 環境光が強すぎて黒のコントラストが消えている</li>
      <li>🎨 黒の HSV (特に V と S) の範囲が厳しすぎる</li>
    </ul>
    <p style="color:#16a34a; font-weight:600;">🛠️ <code>upper_black</code> の V を 80 → 90〜120 にすると改善することが多い！</p>
  </div>

  <!-- ④ ロボットが蛇行する -->
  <div class="trouble-box">
    <h3>④ 🌀 ロボットが蛇行する</h3>
    <p>左右差（<code>diff</code>）の値 55 が強すぎるのが原因かも。</p>
    <ul>
      <li>⚙️ <code>diff</code> を 35〜45 に下げてみる</li>
      <li>🎯 base_speed と diff のバランスも重要</li>
    </ul>
    <p style="color:#2b7bd3; font-weight:600;">🚗 安定したライン走行には “適度な差分調整” が大事！</p>
  </div>

  <!-- ⑤ 進行方向が急に飛ぶ -->
  <div class="trouble-box">
    <h3>⑤ ↔️ 進行方向が急に飛ぶ</h3>
    <p>輪郭ノイズの影響で、cx（重心）が暴れている可能性。</p>
    <ul>
      <li>🧹 マスク画像にガウシアンブラーを追加（もう入ってるので値を強くしてもOK）</li>
      <li>📏 <code>cx</code> 判定閾値（±20）を ±30〜40 に緩める</li>
    </ul>
    <p style="color:#16a34a; font-weight:600;">🧠 ノイズに強い “ゆるめ設定” にすると安定する！</p>
  </div>

  <!-- ⑥ モーターが動かない -->
  <div class="trouble-box">
    <h3>⑥ 🔧 モーターが動かない</h3>
    <p>ポート設定ミス or USB 認識エラーがよくある原因。</p>
    <ul>
      <li>🛠️ <code>add_device('right_motor', ..., port='A')</code> のポートを見直す</li>
      <li>🔌 USB が抜けかけていないかチェック</li>
      <li>🐍 ETRobo の backend が <code>raspike_art</code> になっているか確認</li>
    </ul>
    <p style="color:#2b7bd3; font-weight:600;">💥 ポート違いが “動かない系” の最強原因！</p>
  </div>
  </div>
</section>

</main>

        <!--<video controls>
      <source src="jyuugi_aki.mp4" type="video/mp4"> 
      お使いのブラウザは動画再生に対応していません。
    </video>
    <div class="caption">
      ギャップラインを走行する様子を撮影した動画です。
    </div>  -->


    <!-- ▼ 学習のやり方セクション ▼ -->
    <div class="learn-section">
      <h2>📘 学習のやり方</h2>
      <p>ギャップライントレースの学習では、次の手順で理解を深めましょう。</p>
      <ol class="learn-list">
        <li><b>動作の確認：</b> まずは動画を見て、ロボットがどのように黒線をたどるか観察します。</li>
        <li><b>コードの理解：</b> 各関数の役割（カメラ取得・画像処理・モーター制御）を順に読み解きます。</li>
        <li><b>実験と調整：</b> 黒線の太さやカメラの位置を変えて、プログラムの反応を試してみましょう。</li>
        <li><b>応用：</b> 速度やカーブ処理の調整、または交差点対応の改良などを行ってみます。</li>
      </ol>
      <p>実際にロボットを動かしながら学ぶことで、「センサー」と「プログラム制御」の関係を深く理解できます。</p>
    </div>

  </main>


      <footer>
      <p>&copy; 2025　愛知工業大学　水野勝教研究室 </p>
    </footer>

  </div> <!-- /.wrapper -->

<script>
  function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const menuIcon = document.getElementById('menuIcon');
    sidebar.classList.toggle('open');
    menuIcon.classList.toggle('open');
  }

  document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const menuIcon = document.getElementById('menuIcon');
    if (!e.target.closest('.sidebar') && !e.target.closest('.menu-icon') && sidebar.classList.contains('open')) {
      sidebar.classList.remove('open');
      menuIcon.classList.remove('open');
    }
  });
</script>


</body>
</html>
