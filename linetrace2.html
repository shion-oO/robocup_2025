<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº¤å·®ç‚¹ä»˜ããƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</title>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      color: #2c3e50;
    }

    header {
      background-color: #3498db;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      font-size: 2em;
    }

    nav {
      background-color: #ecf0f1;
      padding: 10px 20px;
      text-align: center;
    }

    nav a {
      color: #3498db;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .caption {
      margin-top: 12px;
      font-size: 16px;
      color: #444;
      text-align: center;
      margin-bottom: 60px;
    }

    h2 {
      color: #3498db;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin-top: 40px;
    }

    .code-section {
      display: flex;
      gap: 30px;
      margin-top: 30px;
      margin-bottom: 70px;
      flex-wrap: wrap;
    }

    .code-box {
      flex: 1;
      min-width: 480px;
      background: #f7f9fb;
      border-radius: 10px;
      padding: 25px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .desc-box {
      flex: 1;
      min-width: 400px;
      background: #eaf4fc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .desc-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    /* â–¼ å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ */
    .learn-section {
      margin-top: 60px;
      background-color: #f7f9fb;
      padding: 40px 30px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .learn-section h2 {
      text-align: center;
      font-size: 1.8em;
      color: #3498db;
      border-bottom: none;
      margin-bottom: 20px;
    }

    .learn-section p {
      font-size: 1.1em;
      line-height: 1.8;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .learn-list {
      list-style: decimal;
      padding-left: 25px;
      font-size: 1.05em;
      line-height: 1.8;
    }

  </style>
</head>
<body>

  <header>
    <h1>äº¤å·®ç‚¹ä»˜ããƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</h1>
  </header>

  <nav>
    <a href="robocup_home.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="linetrace.html">ç™½é»’ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</a>
    <a href="linetrace3.html">ã‚®ãƒ£ãƒƒãƒ—ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹</a>
    <a href="goal.html">ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ«</a>
  </nav>

  <main>
    <video controls>
      <source src="midori_kenti.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
      ç·‘ã‚’æ¤œçŸ¥ã—ã¦ã€é€²è¡Œæ–¹å‘ã‚’åˆ¤æ–­ã™ã‚‹ãƒ­ãƒœãƒƒãƒˆã®å‹•ç”»ã§ã™ã€‚
    </div>

    <h2>midori_kenti.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code># â‘  ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import cv2
import numpy as np
from etrobo_python import ETRobo, Motor, ColorSensor
import time

# â‘¡ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
last_direction = "RIGHT"

# â‘¢ HSVå¤‰æ›é–¢æ•°
def get_hsv_from_sensor(sensor: ColorSensor):
    r, g, b = sensor.get_raw_color()
    rgb = np.uint8([[[r, g, b]]])
    hsv = cv2.cvtColor(rgb, cv2.COLOR_RGB2HSV)
    return hsv[0][0]

# â‘£ ç·‘è‰²æ¤œçŸ¥é–¢æ•°ï¼ˆå·¦ãƒ»å³ï¼‰
def is_green_left(h, s, v):
    return (70 <= h <= 90) and (13 <= s <= 30) and (25 <= v <= 35)

def is_green_right(h, s, v):
    return (75 <= h <= 80) and (120 <= s <= 150) and (35 <= v <= 50)

# â‘¤ ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡é–¢æ•°
def trace_and_turn_on_green(right_motor: Motor, left_motor: Motor,
                            color_sensor_left: ColorSensor, color_sensor_right: ColorSensor):
    global last_direction
    try:
        h_l, s_l, v_l = get_hsv_from_sensor(color_sensor_left)
        h_r, s_r, v_r = get_hsv_from_sensor(color_sensor_right)

        left_is_green = is_green_left(h_l, s_l, v_l)
        right_is_green = is_green_right(h_r, s_r, v_r)

        if left_is_green:
            print(f"[LEFT TURN] Green detected on LEFT sensor (HSV={h_l},{s_l},{v_l})")
            left_motor.set_power(50)
            right_motor.set_power(0)
            time.sleep(1.5)  
            return

        if right_is_green:
            print(f"[RIGHT TURN] Green detected on RIGHT sensor (HSV={h_r},{s_r},{v_r})")
            left_motor.set_power(0)
            right_motor.set_power(50)
            time.sleep(1.5)
            return

        if v_l < 60 and s_l < 100:
            power = 30
            left_motor.set_power(power)
            right_motor.set_power(power)
            last_direction = "STRAIGHT"
        else:
            if last_direction in ["STRAIGHT", "RIGHT"]:
                left_motor.set_power(50)
                right_motor.set_power(0)
                last_direction = "LEFT"
            else:
                left_motor.set_power(0)
                right_motor.set_power(50)
                last_direction = "RIGHT"

        print(f"LEFT HSV=({h_l},{s_l},{v_l}) | RIGHT HSV=({h_r},{s_r},{v_r}) | Dir={last_direction}")

    except Exception as e:
        print(f"[ERROR] {e}")

# â‘¥ å®Ÿè¡Œéƒ¨åˆ†
(ETRobo(backend='raspyke')
 .add_device('right_motor', device_type=Motor, port='B')
 .add_device('left_motor', device_type=Motor, port='C')
 .add_device('color_sensor_left', device_type=ColorSensor, port='S2')
 .add_device('color_sensor_right', device_type=ColorSensor, port='S3')
 .add_handler(trace_and_turn_on_green)
 .dispatch(interval=0.1))
</code></pre>
      </div>

<div class="desc-box">
  <h3>(ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜)</h3>

  <p>
    ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€å·¦å³ã®ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã§å–å¾—ã—ãŸ<strong>RGBå€¤</strong>ã‚’<strong>HSVè‰²ç©ºé–“</strong>ã«å¤‰æ›ã—ã€  
    ç·‘è‰²ã‚’æ¤œå‡ºã—ãŸå´ã«åˆã‚ã›ã¦å³æŠ˜ãƒ»å·¦æŠ˜ã‚’è¡Œã†ã‚ˆã†ã«åˆ¶å¾¡ã—ã¾ã™ã€‚  
    ç·‘ãŒæ¤œå‡ºã•ã‚Œãªã„ã¨ãã¯ãƒ©ã‚¤ãƒ³ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ã¦ç›´é€²ã¾ãŸã¯è£œæ­£èµ°è¡Œã‚’è¡Œã„ã¾ã™ã€‚  
    <strong>eTRoboç’°å¢ƒ</strong>ã§å®Ÿè¡Œã•ã‚Œã€ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ»ã‚»ãƒ³ã‚µãƒ¼ã¯<strong>Raspberry Pi</strong>çµŒç”±ã§åˆ¶å¾¡ã•ã‚Œã¾ã™ã€‚
  </p>

  <h4>â‘  ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h4>
  <p>
    ç”»åƒå‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ<code>cv2</code>, <code>numpy</code>ï¼‰ã¨ã€  
    ETãƒ­ãƒœã‚³ãƒ³ç”¨ãƒ‡ãƒã‚¤ã‚¹åˆ¶å¾¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆ<code>etrobo_python</code>ï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚  
    ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ãƒœãƒƒãƒˆã®ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚„ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã‚’Pythonã‹ã‚‰æ“ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
  </p>

  <h4>â‘¡ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°</h4>
  <p>
    ãƒ­ãƒœãƒƒãƒˆãŒ<strong>ç›´å‰ã«ã©ã¡ã‚‰ã¸é€²ã‚“ã ã‹ï¼ˆå³ãƒ»å·¦ãƒ»ç›´é€²ï¼‰</strong>ã‚’è¨˜éŒ²ã—ã¦ãŠããŸã‚ã®å¤‰æ•°ã§ã™ã€‚  
    æ¬¡ã®å‹•ä½œã‚’æ±ºã‚ã‚‹éš›ã«å‚ç…§ã•ã‚Œã¾ã™ã€‚
  </p>

  <h4>â‘¢ HSVå¤‰æ›é–¢æ•°</h4>
  <p>
    ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰å–å¾—ã—ãŸRGBå€¤ã‚’ã€è‰²æ¤œå‡ºã«é©ã—ãŸ<strong>HSVå½¢å¼</strong>ã«å¤‰æ›ã—ã¾ã™ã€‚  
    HSVã¯ã€Œè‰²ç›¸ï¼ˆHueï¼‰ã€ã€Œå½©åº¦ï¼ˆSaturationï¼‰ã€ã€Œæ˜åº¦ï¼ˆValueï¼‰ã€ã‚’è¡¨ã—ã€  
    ç·‘è‰²ãªã©ã®åˆ¤å®šã‚’å®‰å®šã—ã¦è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
  </p>

  <h4>â‘£ ç·‘è‰²æ¤œçŸ¥é–¢æ•°ï¼ˆå·¦ãƒ»å³ï¼‰</h4>
  <p>
    å·¦å³ã®ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã§å–å¾—ã—ãŸHSVå€¤ãŒã€  
    ã‚ã‚‰ã‹ã˜ã‚è¨­å®šã•ã‚ŒãŸã€Œç·‘è‰²ã®ç¯„å›²ã€ã«å…¥ã£ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚  
    å·¦å³ã§æ¡ä»¶ã‚’å°‘ã—å¤‰ãˆã¦ã„ã‚‹ã®ã¯ã€ç…§æ˜ç’°å¢ƒã‚„ã‚»ãƒ³ã‚µãƒ¼å€‹ä½“å·®ã‚’è£œæ­£ã™ã‚‹ãŸã‚ã§ã™ã€‚
  </p>

  <h4>â‘¤ ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡é–¢æ•°</h4>
  <p>
    ã“ã®é–¢æ•°ãŒãƒ­ãƒœãƒƒãƒˆèµ°è¡Œã®ä¸­å¿ƒã¨ãªã‚‹å‡¦ç†ã§ã™ã€‚
  </p>
  <ol>
    <li>HSVå€¤ã‚’å–å¾—ã—ã€å·¦å³ã®ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰è‰²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ã€‚</li>
    <li>ç·‘è‰²ãŒå·¦ã«ã‚ã‚Œã°å·¦æŠ˜ã€å³ã«ã‚ã‚Œã°å³æŠ˜ã‚’è¡Œã†ã€‚</li>
    <li>ç·‘ãŒãªã„å ´åˆã¯ãƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆå‰é€²ãƒ»å¾®èª¿æ•´ï¼‰ã‚’è¡Œã†ã€‚</li>
    <li>æœ€å¾Œã«ã©ã¡ã‚‰ã¸æ›²ãŒã£ãŸã‹ã‚’è¨˜éŒ²ã—ã€æ¬¡å›ã®è£œæ­£ã«åˆ©ç”¨ã€‚</li>
  </ol>

  <h4>â‘¥ å®Ÿè¡Œéƒ¨åˆ†</h4>
  <p>
    ãƒ­ãƒœãƒƒãƒˆæœ¬ä½“ã‚’åˆæœŸåŒ–ã—ã€ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚„ã‚»ãƒ³ã‚µãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ã€‚  
    <code>dispatch(interval=0.1)</code> ã«ã‚ˆã‚Šã€0.1ç§’ã”ã¨ã«ä¸Šè¨˜ã®åˆ¶å¾¡é–¢æ•°ã‚’ç¹°ã‚Šè¿”ã—å®Ÿè¡Œã—ã¾ã™ã€‚
  </p>
</div>


<table border="1" style="border-collapse: collapse; text-align: left;">
  <tr style="background-color: #f0f0f0;">
    <th>å•é¡Œã®å†…å®¹</th>
    <th>åŸå› </th>
    <th>æ”¹å–„ã®ãƒ’ãƒ³ãƒˆ</th>
  </tr>
  <tr>
    <td>ãƒ­ãƒœãƒƒãƒˆãŒå‹•ã‹ãªã„</td>
    <td>ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚„ã‚»ãƒ³ã‚µãƒ¼ã®ãƒãƒ¼ãƒˆæŒ‡å®šãŒé–“é•ã£ã¦ã„ã‚‹</td>
    <td>ETRoboåˆæœŸåŒ–éƒ¨åˆ†ã§ãƒãƒ¼ãƒˆåï¼ˆä¾‹: 'B', 'C', 'S2', 'S3'ï¼‰ã‚’å†ç¢ºèªã™ã‚‹</td>
  </tr>
  <tr>
    <td>å¸¸ã«å³æŠ˜ã¾ãŸã¯å·¦æŠ˜ã—ã‹ã—ãªã„</td>
    <td>ç·‘è‰²åˆ¤å®šã®HSVç¯„å›²ãŒç‹­ã™ãã‚‹ / ç…§æ˜æ¡ä»¶ãŒç•°ãªã‚‹</td>
    <td>`is_green_left`ã‚„`is_green_right`ã®HSVç¯„å›²ã‚’å°‘ã—åºƒã’ã‚‹ï¼ˆä¾‹: HÂ±5, SÂ±20ãªã©ï¼‰</td>
  </tr>
  <tr>
    <td>ãƒ©ã‚¤ãƒ³ä¸Šã§ãµã‚‰ã¤ã</td>
    <td>ã‚»ãƒ³ã‚µãƒ¼ã®åå¿œé…å»¶ã¾ãŸã¯ãƒ¢ãƒ¼ã‚¿ãƒ¼å‡ºåŠ›ã®ãƒãƒ©ãƒ³ã‚¹</td>
    <td>å·¦å³ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®å‡ºåŠ›æ¯”ï¼ˆ50ã¨30ãªã©ï¼‰ã‚’èª¿æ•´ã™ã‚‹</td>
  </tr>
  <tr>
    <td>ã€Œ[ERROR]ã€ãŒé »ç™ºã™ã‚‹</td>
    <td>ã‚»ãƒ³ã‚µãƒ¼å€¤ãŒå–å¾—ã§ãã¦ã„ãªã„ / ã‚³ãƒã‚¯ã‚¿æ¥è§¦ä¸è‰¯</td>
    <td>ã‚«ãƒ©ãƒ¼ã‚»ãƒ³ã‚µãƒ¼ã®ã‚³ãƒã‚¯ã‚¿ã‚’æŠœãå·®ã—ã—ã¦å†æ¥ç¶šã™ã‚‹</td>
  </tr>
  <tr>
    <td>ç·‘ã‚’æ¤œçŸ¥ã—ã¦ã‚‚åå¿œã—ãªã„</td>
    <td>ã‚»ãƒ³ã‚µãƒ¼ä½ç½®ãŒé ã™ãã‚‹ or HSVç¯„å›²ãŒåˆã£ã¦ã„ãªã„</td>
    <td>ã‚»ãƒ³ã‚µãƒ¼ã®é«˜ã•ã‚’èª¿æ•´ã—ã€å®Ÿéš›ã®ç·‘è‰²ã‚’`print()`ã§ç¢ºèªã—ãªãŒã‚‰ç¯„å›²ã‚’å†è¨­å®šã™ã‚‹</td>
  </tr>
</table>


        <video controls>
      <source src="midori_tyokusin.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
      ç·‘ã®äº¤å·®ç‚¹ã‚’æ¤œçŸ¥ã—ã¦ã€é€²è¡Œæ–¹å‘ã‚’åˆ¤æ–­ã™ã‚‹ãƒ­ãƒœãƒƒãƒˆã®å‹•ç”»ã§ã™ã€‚
    </div>

        <h2>midori_tyokusin.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code>import cv2
import numpy as np
from etrobo_python import ETRobo, Motor, ColorSensor
import time

last_direction = "STRAIGHT"
prev_left_power = -1
prev_right_power = -1
last_log_time = 0
ignore_green_until = 0  # ????????

def get_hsv_from_sensor(sensor: ColorSensor):
    r, g, b = sensor.get_raw_color()
    rgb = np.uint8([[[r, g, b]]])
    hsv = cv2.cvtColor(rgb, cv2.COLOR_RGB2HSV)
    return hsv[0][0]

def is_green(h, s, v):
    return (75 <= h <= 100) and (s == 0 or s >= 60) and v >= 160

def is_black(s, v):
    return s < 100 and v < 80

def set_motor_power_safe(left_motor, right_motor, lp, rp):
    global prev_left_power, prev_right_power
    if lp != prev_left_power:
        left_motor.set_power(lp)
        prev_left_power = lp
    if rp != prev_right_power:
        right_motor.set_power(rp)
        prev_right_power = rp

def trace_with_green_turn(right_motor: Motor, left_motor: Motor,
                          color_sensor_left: ColorSensor, color_sensor_right: ColorSensor):
    global last_direction, last_log_time, ignore_green_until

    try:
        h_l, s_l, v_l = get_hsv_from_sensor(color_sensor_left)
        h_r, s_r, v_r = get_hsv_from_sensor(color_sensor_right)

        left_is_green = is_green(h_l, s_l, v_l)
        right_is_green = is_green(h_r, s_r, v_r)

        left_is_black = is_black(s_l, v_l)
        right_is_black = is_black(s_r, v_r)

        current_time = time.time()

        # --- ?????????????????????? ---
        if left_is_black and right_is_black:
            set_motor_power_safe(left_motor, right_motor, 60, 60)
            last_direction = "STRAIGHT"
            ignore_green_until = current_time + 0.8  # ??????
            print("[CROSS] BOTH BLACK ? GO STRAIGHT & IGNORE GREEN")
            return
            # --- ??????????????????? ---
        if current_time > ignore_green_until:
            if left_is_green and not left_is_black:
                print(f"[LEFT TURN] GREEN DETECTED: L=({h_l},{s_l},{v_l})")
                start = time.time()
                while time.time() - start < 0.7:
                    set_motor_power_safe(left_motor, right_motor, 100, 0)
                    time.sleep(0.05)
                print("[ADJUST] Turning LEFT adjust")
                set_motor_power_safe(left_motor, right_motor, 30, 100)
                time.sleep(1.0)
                return

            if right_is_green and not right_is_black:
                print(f"[RIGHT TURN] GREEN DETECTED: R=({h_r},{s_r},{v_r})")
                start = time.time()
                while time.time() - start < 0.7:
                    set_motor_power_safe(left_motor, right_motor, 0, 100)
                    time.sleep(0.05)
                print("[ADJUST] Turning RIGHT adjust")
                set_motor_power_safe(left_motor, right_motor, 100, 30)
                time.sleep(1.0)
                return
        else:
            if left_is_green or right_is_green:
                print(f"[IGNORE GREEN] L=({h_l},{s_l},{v_l}) | R=({h_r},{s_r},{v_r})")

        # --- ???????? ---
        if left_is_black and not right_is_black:
            set_motor_power_safe(left_motor, right_motor, 30, 70)
            last_direction = "LEFT"
        elif right_is_black and not left_is_black:
            set_motor_power_safe(left_motor, right_motor, 70, 30)
            last_direction = "RIGHT"
        elif not left_is_black and not right_is_black:
            print("[NO BLACK] ?????")
            set_motor_power_safe(left_motor, right_motor, 60, 60)
            last_direction = "STRAIGHT"

        # --- ?????1???? ---
        if current_time - last_log_time > 1.0:
            print(f"HSV L=({h_l},{s_l},{v_l}) | R=({h_r},{s_r},{v_r}) | Dir={last_direction}")
            last_log_time = current_time

    except Exception as e:
        print(f"[ERROR] {e}")

# === ?? ===
(ETRobo(backend='raspike_art')
 .add_device('right_motor', device_type=Motor, port='B')
 .add_device('left_motor', device_type=Motor, port='A')
 .add_device('color_sensor_left', device_type=ColorSensor, port='D')
 .add_device('color_sensor_right', device_type=ColorSensor, port='C')
 .add_handler(trace_with_green_turn)
 .dispatch(interval=0.2, port='/dev/ttyACM0'))
</code></pre>
      </div>

      <div class="desc-box">
        <h3>(ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜)</h3>
        <p><b>1ï¸âƒ£ ç·‘æ¤œçŸ¥ï¼š</b> HSVè‰²ç©ºé–“ã§ç·‘è‰²ã®ç¯„å›²ã‚’æŠ½å‡ºã—ã€äº¤å·®ç‚¹ä½ç½®ã‚’æ¤œå‡ºã—ã¾ã™ã€‚</p>
        <p><b>2ï¸âƒ£ å‹•ä½œåˆ¤æ–­ï¼š</b> ç·‘ã‚’è¦‹ã¤ã‘ãŸã‚‰å³æŠ˜å‹•ä½œã‚’å®Ÿè¡Œã—ã€æ–¹å‘è»¢æ›ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <p><b>3ï¸âƒ£ é€šå¸¸èµ°è¡Œï¼š</b> ç·‘ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç™½é»’ãƒ©ã‚¤ãƒ³ã®è¿½å¾“ã‚’ç¶šã‘ã¾ã™ã€‚</p>
      </div>
    </div>

        <video controls>
      <source src="midori_u.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
      ç·‘ã®äº¤å·®ç‚¹ã‚’æ¤œçŸ¥ã—ã¦ã€é€²è¡Œæ–¹å‘ã‚’åˆ¤æ–­ã™ã‚‹ãƒ­ãƒœãƒƒãƒˆã®å‹•ç”»ã§ã™ã€‚
    </div>


        <h2>midori_u.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code>import cv2
import numpy as np
from etrobo_python import ETRobo, Motor, ColorSensor
import time

last_direction = "STRAIGHT"
prev_left_power = -1
prev_right_power = -1
last_log_time = 0

# ?????HSV?3?????????
def get_stable_hsv(sensor: ColorSensor, samples=10, delay=0.02):
    h_list, s_list, v_list = [], [], []
    for _ in range(samples):
        r, g, b = sensor.get_raw_color()
        rgb = np.uint8([[[r, g, b]]])
        hsv = cv2.cvtColor(rgb, cv2.COLOR_RGB2HSV)[0][0]
        h_list.append(hsv[0])
        s_list.append(hsv[1])
        v_list.append(hsv[2])
        time.sleep(delay)
    return int(np.mean(h_list)), int(np.mean(s_list)), int(np.mean(v_list))

# ?????S=0 ???? >=60 / V >=160?
def is_green(h, s, v):
    return (75 <= h <= 100) and (s == 0 or s >= 60) and v >= 160

# ???????????????
def is_black(s, v):
    return s < 100 and v < 80

# ???????????????
def set_motor_power_safe(left_motor, right_motor, lp, rp):
    global prev_left_power, prev_right_power
    if lp != prev_left_power:
        left_motor.set_power(lp)
        prev_left_power = lp
    if rp != prev_right_power:
        right_motor.set_power(rp)
        prev_right_power = rp
# ????????????????????
def trace_with_green_turn(right_motor: Motor, left_motor: Motor,
                          color_sensor_left: ColorSensor, color_sensor_right: ColorSensor):
    global last_direction, last_log_time

    try:
        h_l, s_l, v_l = get_stable_hsv(color_sensor_left)
        h_r, s_r, v_r = get_stable_hsv(color_sensor_right)

        left_is_green = is_green(h_l, s_l, v_l)
        right_is_green = is_green(h_r, s_r, v_r)

        left_is_black = is_black(s_l, v_l)
        right_is_black = is_black(s_r, v_r)

        current_time = time.time()

        # === ????U????===
        if left_is_green and right_is_green:
            print(f"[U-TURN] ???: L=({h_l},{s_l},{v_l}) R=({h_r},{s_r},{v_r})")
            start = time.time()
            while time.time() - start < 0.7:
                set_motor_power_safe(left_motor, right_motor, 100, -100)
                time.sleep(18.0)
            print("[U-TURN COMPLETE]")
            return

        # === ?????????===
        elif left_is_green and not left_is_black:
            print(f"[LEFT TURN] ?: L=({h_l},{s_l},{v_l})")
            start = time.time()
            while time.time() - start < 0.7:
                set_motor_power_safe(left_motor, right_motor, 100, 0)
                time.sleep(1.5)
            print("[ADJUST] ???? ??")
            set_motor_power_safe(left_motor, right_motor, 30, 100)
            time.sleep(1.0)
            return

        # === ?????????===
        elif right_is_green and not right_is_black:
            print(f"[RIGHT TURN] ?: R=({h_r},{s_r},{v_r})")
            start = time.time()
            while time.time() - start < 0.7:
                set_motor_power_safe(left_motor, right_motor, 0, 100)
                time.sleep(1.5)
            print("[ADJUST] ???? ??")
            set_motor_power_safe(left_motor, right_motor, 100, 30)
            time.sleep(1.0)
            return

        # === ??????????===
        if left_is_black and not right_is_black:
            set_motor_power_safe(left_motor, right_motor, 30, 70)
            last_direction = "LEFT"
        elif right_is_black and not left_is_black:
            set_motor_power_safe(left_motor, right_motor, 70, 30)
            last_direction = "RIGHT"
        elif left_is_black and right_is_black:
            set_motor_power_safe(left_motor, right_motor, 60, 60)
            last_direction = "STRAIGHT"
        else:
            # ????????????
            print("[NO BLACK] ?????????????")
            set_motor_power_safe(left_motor, right_motor, 60, 60)
            last_direction = "STRAIGHT"

        # === ???1????===
        if current_time - last_log_time > 1.0:
            print(f"HSV L=({h_l},{s_l},{v_l}) | R=({h_r},{s_r},{v_r}) | Dir={last_direction}")
            last_log_time = current_time

    except Exception as e:
        print(f"[ERROR] {e}")

# === ????????????????===
(ETRobo(backend='raspike_art')
 .add_device('right_motor', device_type=Motor, port='B')
 .add_device('left_motor', device_type=Motor, port='A')
 .add_device('color_sensor_left', device_type=ColorSensor, port='D')
 .add_device('color_sensor_right', device_type=ColorSensor, port='C')
 .add_handler(trace_with_green_turn)
 .dispatch(interval=0.2, port='/dev/ttyACM0'))

</code></pre>
      </div>

      <div class="desc-box">
        <h3>(ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜)</h3>
        <p><b>1ï¸âƒ£ ç·‘æ¤œçŸ¥ï¼š</b> HSVè‰²ç©ºé–“ã§ç·‘è‰²ã®ç¯„å›²ã‚’æŠ½å‡ºã—ã€äº¤å·®ç‚¹ä½ç½®ã‚’æ¤œå‡ºã—ã¾ã™ã€‚</p>
        <p><b>2ï¸âƒ£ å‹•ä½œåˆ¤æ–­ï¼š</b> ç·‘ã‚’è¦‹ã¤ã‘ãŸã‚‰å³æŠ˜å‹•ä½œã‚’å®Ÿè¡Œã—ã€æ–¹å‘è»¢æ›ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <p><b>3ï¸âƒ£ é€šå¸¸èµ°è¡Œï¼š</b> ç·‘ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç™½é»’ãƒ©ã‚¤ãƒ³ã®è¿½å¾“ã‚’ç¶šã‘ã¾ã™ã€‚</p>
      </div>
    </div>



            <video controls>
      <source src="midori_hidari.mp4" type="video/mp4">
      ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
    </video>
    <div class="caption">
      ç·‘ã®äº¤å·®ç‚¹ã‚’æ¤œçŸ¥ã—ã¦ã€é€²è¡Œæ–¹å‘ã‚’åˆ¤æ–­ã™ã‚‹ãƒ­ãƒœãƒƒãƒˆã®å‹•ç”»ã§ã™ã€‚
    </div>


        <h2>midori_hidari.py</h2>
    <div class="code-section">
      <div class="code-box">
        <pre><code>import cv2
import numpy as np
from etrobo_python import ETRobo, Motor, ColorSensor
import time

last_direction = "RIGHT"  # ?????????

def get_hsv_from_sensor(sensor: ColorSensor):
    r, g, b = sensor.get_raw_color()
    rgb = np.uint8([[[r, g, b]]])
    hsv = cv2.cvtColor(rgb, cv2.COLOR_RGB2HSV)
    return hsv[0][0]

def is_green(h, s, v):
    return (75 <= h <= 100) and (s == 0 or s >= 150) and v >= 160

def trace_and_turn_on_green(right_motor: Motor, left_motor: Motor,
                            color_sensor_left: ColorSensor, color_sensor_right: ColorSensor):
    global last_direction
    try:
        h_l, s_l, v_l = get_hsv_from_sensor(color_sensor_left)
        h_r, s_r, v_r = get_hsv_from_sensor(color_sensor_right)

        left_is_green = is_green(h_l, s_l, v_l)
        right_is_green = is_green(h_r, s_r, v_r)

        # === ?????? ? ???? ===
        if left_is_green and right_is_green:
            print(f"[STOP] BOTH GREEN: L=({h_l},{s_l},{v_l}) | R=({h_r},{s_r},{v_r})")
            left_motor.set_power(0)
            right_motor.set_power(0)

            # ?????????
            while True:
                h_l, s_l, v_l = get_hsv_from_sensor(color_sensor_left)
                h_r, s_r, v_r = get_hsv_from_sensor(color_sensor_right)
                if not (is_green(h_l, s_l, v_l) and is_green(h_r, s_r, v_r)):
                    print("[RESUME] Green cleared. Resuming motion.")
                    break
                time.sleep(0.1)
            return

        # === ???????? ===
        if left_is_green:
            print(f"[LEFT TURN] LEFT GREEN. HSV=({h_l},{s_l},{v_l})")
            start_time = time.time()
            while time.time() - start_time < 8.5:
                left_motor.set_power(100)
                right_motor.set_power(0)
                time.sleep(0.05)
            return

        if right_is_green:
            print(f"[RIGHT TURN] RIGHT GREEN. HSV=({h_r},{s_r},{v_r})")
            start_time = time.time()
            while time.time() - start_time < 8.5:
                left_motor.set_power(0)
                right_motor.set_power(100)
                time.sleep(0.05)
            return

        # === ?????????? ===
        if v_l < 60 and s_l < 100:
            power = 30
            left_motor.set_power(power)
            right_motor.set_power(power)
            last_direction = "STRAIGHT"
        else:
            if last_direction in ["STRAIGHT", "RIGHT"]:
                left_motor.set_power(60)
                right_motor.set_power(0)
                last_direction = "LEFT"
            else:
                left_motor.set_power(0)
                right_motor.set_power(60)
                last_direction = "RIGHT"

        print(f"HSV L=({h_l},{s_l},{v_l}) | R=({h_r},{s_r},{v_r}) | Dir={last_direction}")

    except Exception as e:
        print(f"[ERROR] {e}")

# === ???? ===
(ETRobo(backend='raspike_art')
 .add_device('right_motor', device_type=Motor, port='B')
 .add_device('left_motor', device_type=Motor, port='A')
 .add_device('color_sensor_left', device_type=ColorSensor, port='D')
 .add_device('color_sensor_right', device_type=ColorSensor, port='C')
 .add_handler(trace_and_turn_on_green)
 .dispatch(interval=0.1, port='/dev/ttyACM0'))
</code></pre>
      </div>

      <div class="desc-box">
        <h3>(ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èª¬æ˜)</h3>
        <p><b>1ï¸âƒ£ ç·‘æ¤œçŸ¥ï¼š</b> HSVè‰²ç©ºé–“ã§ç·‘è‰²ã®ç¯„å›²ã‚’æŠ½å‡ºã—ã€äº¤å·®ç‚¹ä½ç½®ã‚’æ¤œå‡ºã—ã¾ã™ã€‚</p>
        <p><b>2ï¸âƒ£ å‹•ä½œåˆ¤æ–­ï¼š</b> ç·‘ã‚’è¦‹ã¤ã‘ãŸã‚‰å³æŠ˜å‹•ä½œã‚’å®Ÿè¡Œã—ã€æ–¹å‘è»¢æ›ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <p><b>3ï¸âƒ£ é€šå¸¸èµ°è¡Œï¼š</b> ç·‘ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç™½é»’ãƒ©ã‚¤ãƒ³ã®è¿½å¾“ã‚’ç¶šã‘ã¾ã™ã€‚</p>
      </div>
    </div>


    <!-- â–¼ å­¦ç¿’ã®ã‚„ã‚Šæ–¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â–¼ -->
    <div class="learn-section">
      <h2>ğŸ“˜ å­¦ç¿’ã®ã‚„ã‚Šæ–¹</h2>
      <p>äº¤å·®ç‚¹ä»˜ããƒ©ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ã‚¹ã®å­¦ç¿’ã§ã¯ã€æ¬¡ã®æ‰‹é †ã§ç·´ç¿’ã‚’é€²ã‚ã¾ã—ã‚‡ã†ã€‚</p>
      <ol class="learn-list">
        <li><b>ç·‘æ¤œçŸ¥ã®ç¢ºèªï¼š</b> ç·‘ã®ãƒ†ãƒ¼ãƒ—ã‚’è¨­ç½®ã—ã€ã‚«ãƒ¡ãƒ©ãŒæ­£ç¢ºã«èªè­˜ã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚</li>
        <li><b>å‹•ä½œãƒ†ã‚¹ãƒˆï¼š</b> ç·‘ã‚’æ¤œå‡ºã—ãŸéš›ã«å³æŠ˜ãƒ»å·¦æŠ˜ãªã©æ­£ã—ã„å‹•ä½œãŒã§ãã‚‹ã‹è©¦ã—ã¾ã™ã€‚</li>
        <li><b>åˆ¤å®šèª¿æ•´ï¼š</b> ç…§æ˜ã‚„ã‚«ãƒ¡ãƒ©ã®è§’åº¦ã«ã‚ˆã£ã¦èªè­˜ç²¾åº¦ãŒå¤‰åŒ–ã™ã‚‹ãŸã‚ã€é–¾å€¤ã‚’å¾®èª¿æ•´ã—ã¾ã™ã€‚</li>
        <li><b>å¿œç”¨ç·´ç¿’ï¼š</b> è¤‡æ•°ã®äº¤å·®ç‚¹ã‚’è¨­ç½®ã—ã¦ã€é€£ç¶šçš„ãªåˆ¤æ–­ã¨åˆ¶å¾¡ã‚’è©¦ã¿ã¾ã—ã‚‡ã†ã€‚</li>
      </ol>
      <p>ç·‘ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã€ŒæŒ‡ç¤ºä¿¡å·ã€ã¨ã—ã¦æ‰±ã†ã“ã¨ã§ã€ã‚ˆã‚Šé«˜åº¦ãªè‡ªå¾‹èµ°è¡Œåˆ¶å¾¡ã«è¿‘ã¥ã‘ã¾ã™ã€‚</p>
    </div>

  </main>

</body>
</html>
